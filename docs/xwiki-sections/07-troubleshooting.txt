= (% id="H7" %)ğŸ”§ 7. ìƒì„¸ ë¬¸ì œ í•´ê²° =

{{panel title="**âœ¨ ì´ ì„¹ì…˜ì—ì„œ ë°°ìš¸ ë‚´ìš©**"}}
* â˜‘ï¸ 8ê°€ì§€ ì£¼ìš” ì¦ìƒë³„ í•´ê²° ë°©ë²• (v3.3.7: Traefik ì´ìŠˆ í¬í•¨)
* â˜‘ï¸ ì›ì¸ ë¶„ì„ ë° ì§„ë‹¨ ëª…ë ¹ì–´
* â˜‘ï¸ ë‹¨ê³„ë³„ í•´ê²° í”„ë¡œì„¸ìŠ¤
* â˜‘ï¸ ì˜ˆë°© ì¡°ì¹˜
{{/panel}}

---

== ğŸš¨ ì¦ìƒ 1: ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ ==

=== ì›ì¸ 1-1: í¬íŠ¸ ì¶©ëŒ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}Error starting userland proxy: listen tcp4 0.0.0.0:2542: bind: address already in use{{/code}}
{{/warning}}

{{info}}
**v3.3.7 ì°¸ê³ **: í¬íŠ¸ 2542, 2543ì€ Docker ë‚´ë¶€ ì „ìš©ì…ë‹ˆë‹¤. ì™¸ë¶€ ì ‘ê·¼ì€ Traefik(80/443)ì„ í†µí•´ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
{{/info}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ë‚´ë¶€ í¬íŠ¸ ì‚¬ìš© í™•ì¸ (blacklist-network ë‚´ë¶€)
netstat -tlnp | grep -E '2542|2543|5432|6379'
# ë˜ëŠ”
ss -tlnp | grep -E '2542|2543|5432|6379'

# íŠ¹ì • í¬íŠ¸ ìƒì„¸ í™•ì¸
lsof -i :2542

# v3.3.7: ì™¸ë¶€ ì ‘ê·¼ìš© Traefik í¬íŠ¸ í™•ì¸
netstat -tlnp | grep -E '80|443'
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë°©ë²• 1: ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
kill -9 <PID>

# ë°©ë²• 2 (v3.3.7): ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆí•„ìš”
# í¬íŠ¸ 2542, 2543ì€ Docker ë‚´ë¶€ ì „ìš©ì´ë¯€ë¡œ ì™¸ë¶€ ì¶©ëŒ ì—†ìŒ
# docker-compose.ymlì—ëŠ” ports ë§¤í•‘ì´ ì—†ì–´ì•¼ ì •ìƒ

# ë°©ë²• 3: docker-compose.yml í™•ì¸ (v3.3.7)
# blacklist-app, blacklist-frontendì— ports ë§¤í•‘ ì œê±°ë¨
# exposeë§Œ ì‚¬ìš© (ë‚´ë¶€ ì „ìš©)

docker-compose up -d
{{/code}}

=== ì›ì¸ 1-2: ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}ERROR: could not find an available, non-overlapping IPv4 address pool{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Docker ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
docker network ls
docker network inspect blacklist-network

# IP ëŒ€ì—­ ì¶©ëŒ í™•ì¸
ip route | grep 172.25
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë„¤íŠ¸ì›Œí¬ ì¬ìƒì„±
docker-compose down
docker network rm blacklist-network
docker network create blacklist-network --subnet 172.25.0.0/16
docker-compose up -d

# ë˜ëŠ” ë‹¤ë¥¸ ì„œë¸Œë„· ì‚¬ìš©
docker network create blacklist-network --subnet 172.26.0.0/16
# docker-compose.ymlì—ì„œ IPë„ ë³€ê²½ í•„ìš”
{{/code}}

=== ì›ì¸ 1-3: ê¶Œí•œ ë¬¸ì œ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}FATAL: data directory has wrong ownership{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ë³¼ë¥¨ ê¶Œí•œ í™•ì¸
ls -la /opt/blacklist-data/
ls -la /opt/blacklist-data/postgres/
ls -la /opt/blacklist-data/redis/
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# PostgreSQL ë°ì´í„° ë””ë ‰í† ë¦¬ (UID=999)
chown -R 999:999 /opt/blacklist-data/postgres
chmod 700 /opt/blacklist-data/postgres

# Redis ë°ì´í„° ë””ë ‰í† ë¦¬ (UID=999)
chown -R 999:999 /opt/blacklist-data/redis
chmod 755 /opt/blacklist-data/redis

# SELinux ì»¨í…ìŠ¤íŠ¸ (RHEL)
chcon -R -t container_file_t /opt/blacklist-data/

# ì¬ì‹œì‘
docker-compose restart blacklist-postgres blacklist-redis
{{/code}}

=== ì›ì¸ 1-4: ë””ìŠ¤í¬ ë¶€ì¡± ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}Error response from daemon: no space left on device{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
df -h
docker system df

# í° ë¡œê·¸ íŒŒì¼ ì°¾ê¸°
find /var/lib/docker/containers -name "*.log" -size +100M -ls
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# Docker ì‹œìŠ¤í…œ ì •ë¦¬
docker system prune -a --volumes
# ì£¼ì˜: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€/ë³¼ë¥¨ ëª¨ë‘ ì‚­ì œ

# ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ (7ì¼ ì´ìƒ)
find /var/lib/docker/containers -name "*.log" -mtime +7 -delete

# ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì • (/etc/docker/daemon.json)
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}

systemctl restart docker
{{/code}}

---

== ğŸš¨ ì¦ìƒ 2: DB ì—°ê²° ì‹¤íŒ¨ ==

=== ì›ì¸ 2-1: ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}psycopg2.OperationalError: FATAL: password authentication failed{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# .env íŒŒì¼ í™•ì¸
grep POSTGRES_PASSWORD .env

# PostgreSQL ì»¨í…Œì´ë„ˆ í™˜ê²½ë³€ìˆ˜ í™•ì¸
docker exec blacklist-postgres env | grep POSTGRES_PASSWORD
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
docker exec -it blacklist-postgres \
  psql -U postgres -c "ALTER USER postgres PASSWORD 'new_password';"

# .env íŒŒì¼ ë™ê¸°í™”
vi .env
# POSTGRES_PASSWORD=new_password

# ì•± ì¬ì‹œì‘
docker-compose restart blacklist-app blacklist-collector
{{/code}}

=== ì›ì¸ 2-2: ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ ë¬¸ì œ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
docker exec blacklist-app ping -c 3 blacklist-postgres

# DNS í•´ì„ í…ŒìŠ¤íŠ¸
docker exec blacklist-app nslookup blacklist-postgres

# ë„¤íŠ¸ì›Œí¬ í™•ì¸
docker inspect blacklist-app | jq '.[0].NetworkSettings.Networks'
docker inspect blacklist-postgres | jq '.[0].NetworkSettings.Networks'
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²°
docker network connect blacklist-network blacklist-app
docker network connect blacklist-network blacklist-postgres

# ë˜ëŠ” ì „ì²´ ì¬ì‹œì‘
docker-compose down
docker-compose up -d
{{/code}}

=== ì›ì¸ 2-3: PostgreSQL ì„œë¹„ìŠ¤ ë‹¤ìš´ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# PostgreSQL ìƒíƒœ í™•ì¸
docker-compose ps blacklist-postgres

# ë¡œê·¸ í™•ì¸
docker-compose logs blacklist-postgres | tail -50

# ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸
docker exec -it blacklist-postgres pg_isready -U postgres -d blacklist
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ì¬ì‹œì‘
docker-compose restart blacklist-postgres

# ìˆ˜ë™ ì—°ê²° í…ŒìŠ¤íŠ¸
docker exec -it blacklist-postgres psql -U postgres -d blacklist

# ë°ì´í„° ë””ë ‰í† ë¦¬ ë³µêµ¬ (ì‹¬ê°í•œ ê²½ìš°)
docker-compose down
docker volume rm blacklist_postgres_data
docker-compose up -d
# ì£¼ì˜: ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥, ë°±ì—… ë³µì› í•„ìš”
{{/code}}

---

== ğŸš¨ ì¦ìƒ 3: REGTECH ìˆ˜ì§‘ ì‹¤íŒ¨ ==

=== ì›ì¸ 3-1: ì¸ì¦ ë§Œë£Œ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}Authentication failed: Invalid credentials{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ì¸ì¦ ì •ë³´ í™•ì¸
docker exec blacklist-postgres psql -U postgres -d blacklist \
  -c "SELECT * FROM collection_credentials WHERE service_name='REGTECH';"

# í™˜ê²½ë³€ìˆ˜ í™•ì¸
docker exec blacklist-collector env | grep REGTECH
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ìˆ˜ë™ ì¸ì¦ í…ŒìŠ¤íŠ¸
docker exec -it blacklist-collector python3 << 'EOF'
from collector.api.regtech_api import authenticate
result = authenticate()
print(result)
EOF

# ìƒˆ ì¸ì¦ ì •ë³´ ë“±ë¡
docker exec blacklist-postgres psql -U postgres -d blacklist << 'SQL'
UPDATE collection_credentials
SET username = 'new_regtech_id',
    password = 'new_regtech_pw',
    updated_at = CURRENT_TIMESTAMP
WHERE service_name = 'REGTECH';
SQL

# ìˆ˜ì§‘ê¸° ì¬ì‹œì‘
docker-compose restart blacklist-collector
{{/code}}

=== ì›ì¸ 3-2: ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# REGTECH í¬í„¸ ì—°ê²° í…ŒìŠ¤íŠ¸
docker exec blacklist-collector \
  curl -I https://regtech.example.com --connect-timeout 10

# DNS í•´ì„
docker exec blacklist-collector nslookup regtech.example.com
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# íƒ€ì„ì•„ì›ƒ ì¦ê°€ (collector/config.py)
docker exec -it blacklist-collector bash
vi /app/collector/config.py
# REQUEST_TIMEOUT = 60  # 30 â†’ 60ì´ˆ

# ì¬ì‹œì‘
docker-compose restart blacklist-collector

# í”„ë¡ì‹œ ì„¤ì • (í•„ìš” ì‹œ)
# .envì— ì¶”ê°€:
# HTTP_PROXY=http://proxy.company.com:8080
# HTTPS_PROXY=http://proxy.company.com:8080
{{/code}}

=== ì›ì¸ 3-3: Excel íŒŒì‹± ì˜¤ë¥˜ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ë¡œê·¸ì—ì„œ ì˜¤ë¥˜ í™•ì¸
docker-compose logs blacklist-collector | grep -i "parse error"
docker-compose logs blacklist-collector | grep -i "excel"

# ìˆ˜ë™ íŒŒì‹± í…ŒìŠ¤íŠ¸
docker exec -it blacklist-collector python3 << 'EOF'
import pandas as pd
df = pd.read_excel('/tmp/test.xlsx', engine='openpyxl')
print(df.head())
EOF
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="python"}}
# collector/parsers/excel_parser.py ìˆ˜ì •

import pandas as pd
import openpyxl

def parse_excel(file_path):
    """Excel íŒŒì‹± (ë‹¤ì¤‘ ì—”ì§„ í´ë°±)"""
    try:
        # 1ì°¨ ì‹œë„: openpyxl (xlsx)
        df = pd.read_excel(file_path, engine='openpyxl')
        return df
    except Exception as e:
        print(f"openpyxl ì‹¤íŒ¨: {e}")
        try:
            # 2ì°¨ ì‹œë„: xlrd (xls ë°”ì´ë„ˆë¦¬)
            df = pd.read_excel(file_path, engine='xlrd')
            return df
        except Exception as e2:
            print(f"xlrd ì‹¤íŒ¨: {e2}")
            # 3ì°¨ ì‹œë„: ìˆ˜ë™ íŒŒì‹±
            return parse_excel_manual(file_path)
{{/code}}

---

== ğŸš¨ ì¦ìƒ 4: ì„±ëŠ¥ ì €í•˜ ==

=== ì›ì¸ 4-1: ìºì‹œ íˆíŠ¸ìœ¨ ë‚®ìŒ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Redis í†µê³„ í™•ì¸
docker exec blacklist-redis redis-cli INFO stats | grep keyspace

# í‚¤ ê°œìˆ˜ í™•ì¸
docker exec blacklist-redis redis-cli DBSIZE

# ìºì‹œ íˆíŠ¸ìœ¨ ê³„ì‚°
docker exec blacklist-redis redis-cli INFO stats | grep -E "keyspace_hits|keyspace_misses"
# ëª©í‘œ: hits / (hits + misses) â‰¥ 0.85
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë°©ë²• 1: TTL ì¦ê°€ (app/core/services/blacklist_service.py)
# CACHE_TTL = 7200  # 1ì‹œê°„ â†’ 2ì‹œê°„

# ë°©ë²• 2: Redis ë©”ëª¨ë¦¬ ì¦ê°€
# docker-compose.yml
# redis:
#   command: redis-server --maxmemory 4gb

# ë°©ë²• 3: ìºì‹œ ì›Œë°ì—… (ìì£¼ ì‚¬ìš©ë˜ëŠ” IP ë¯¸ë¦¬ ë¡œë“œ)
docker exec blacklist-app python3 << 'EOF'
from core.services.blacklist_service import BlacklistService
service = BlacklistService()
# Top 1000 IPs ìºì‹œ
for ip in top_1000_ips:
    service.check_blacklist(ip)
EOF
{{/code}}

=== ì›ì¸ 4-2: DB ì¿¼ë¦¬ ëŠë¦¼ ===

**ğŸ” ì§„ë‹¨:**

{{code language="sql"}}
-- PostgreSQL ëŠë¦° ì¿¼ë¦¬ í™•ì¸
-- (pg_stat_statements í™•ì¥ í•„ìš”)

SELECT
    query,
    mean_exec_time,
    calls,
    (mean_exec_time * calls) as total_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- ì¿¼ë¦¬ í”Œëœ ë¶„ì„
EXPLAIN ANALYZE
SELECT * FROM blacklist_ips WHERE ip_address = '1.2.3.4';
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="sql"}}
-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_blacklist_country ON blacklist_ips(country);
CREATE INDEX idx_blacklist_active ON blacklist_ips(is_active) WHERE is_active = true;
CREATE INDEX idx_blacklist_detection_date ON blacklist_ips(detection_date DESC);

-- ë¶€ë¶„ ì¸ë±ìŠ¤ (í™œì„± IPë§Œ)
CREATE INDEX idx_blacklist_active_ips ON blacklist_ips(ip_address)
WHERE is_active = true;

-- í†µê³„ ì—…ë°ì´íŠ¸
ANALYZE blacklist_ips;
ANALYZE whitelist_ips;

-- VACUUM (ì •ê¸°ì ìœ¼ë¡œ ì‹¤í–‰)
VACUUM ANALYZE;
{{/code}}

=== ì›ì¸ 4-3: ë””ìŠ¤í¬ I/O ë³‘ëª© ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# I/O í†µê³„ í™•ì¸
iostat -x 1 10

# PostgreSQL I/O ëŒ€ê¸°
docker exec blacklist-postgres psql -U postgres << 'SQL'
SELECT
    pid,
    usename,
    state,
    wait_event_type,
    wait_event
FROM pg_stat_activity
WHERE wait_event_type = 'IO';
SQL
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="sql"}}
-- PostgreSQL ì„¤ì • íŠœë‹
ALTER SYSTEM SET shared_buffers = '4GB';
ALTER SYSTEM SET effective_cache_size = '12GB';
ALTER SYSTEM SET work_mem = '16MB';
ALTER SYSTEM SET maintenance_work_mem = '512MB';
ALTER SYSTEM SET random_page_cost = 1.1;  -- SSD ì‚¬ìš© ì‹œ

SELECT pg_reload_conf();
{{/code}}

{{code language="bash"}}
# SSD ì‚¬ìš© ë˜ëŠ” RAID ì„¤ì •
# ë³¼ë¥¨ì„ SSDì— ë§ˆìš´íŠ¸
mkdir /mnt/ssd/blacklist-data
mount /dev/sdb1 /mnt/ssd/blacklist-data

# docker-compose.ymlì—ì„œ ë³¼ë¥¨ ê²½ë¡œ ë³€ê²½
# volumes:
#   - /mnt/ssd/blacklist-data/postgres:/var/lib/postgresql/data
{{/code}}

---

== ğŸš¨ ì¦ìƒ 5: ë©”ëª¨ë¦¬ ë¶€ì¡± ==

=== ì›ì¸ 5-1: OOM Killer ë°œë™ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: ì»¨í…Œì´ë„ˆê°€ ì˜ˆê¸°ì¹˜ ì•Šê²Œ ì¢…ë£Œë˜ê³  {{code}}Exited (137){{/code}} í‘œì‹œ
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# OOM ë¡œê·¸ í™•ì¸
dmesg | grep -i "out of memory"
journalctl -u docker.service | grep -i "oom"

# ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì½”ë“œ í™•ì¸
docker inspect blacklist-app | jq '.[0].State.ExitCode'
# 137 = SIGKILL (OOM)
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="yaml"}}
# docker-compose.ymlì— ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •

services:
  blacklist-app:
    mem_limit: 2g
    mem_reservation: 1g
    memswap_limit: 2g

  blacklist-postgres:
    mem_limit: 4g
    mem_reservation: 2g

  blacklist-redis:
    mem_limit: 2g
    mem_reservation: 1g
{{/code}}

=== ì›ì¸ 5-2: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
docker stats --no-stream

# Python ë©”ëª¨ë¦¬ í”„ë¡œíŒŒì¼ë§
docker exec blacklist-app pip install memory_profiler
docker exec blacklist-app python -m memory_profiler app/run_app.py
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ì„ì‹œ ì¡°ì¹˜: ì •ê¸° ì¬ì‹œì‘ (cron)
0 3 * * * docker-compose restart blacklist-app

# ê·¼ë³¸ ì›ì¸ ìˆ˜ì • (ì½”ë“œ ë ˆë²¨)
# - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í’€ í¬ê¸° ì œí•œ
# - í° ê°ì²´ ëª…ì‹œì  ì‚­ì œ (del)
# - ìˆœí™˜ ì°¸ì¡° ì œê±°
{{/code}}

=== ì›ì¸ 5-3: Swap ì‚¬ìš©ëŸ‰ ì¦ê°€ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Swap í™•ì¸
free -h
swapon --show

# í”„ë¡œì„¸ìŠ¤ë³„ Swap ì‚¬ìš©ëŸ‰
for file in /proc/*/status ; do awk '/VmSwap|Name/{printf $2 " " $3}END{ print ""}' $file; done | sort -k 2 -n -r | head
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# Swappiness ì¡°ì • (ê¸°ë³¸ 60 â†’ 10)
sysctl vm.swappiness=10
echo "vm.swappiness=10" >> /etc/sysctl.conf

# Swap ë¹„í™œì„±í™” (ì¶©ë¶„í•œ RAM ìˆì„ ê²½ìš°)
swapoff -a
sed -i '/swap/d' /etc/fstab

# ë˜ëŠ” RAM ì¦ì„¤
{{/code}}

---

== ğŸš¨ ì¦ìƒ 6: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë¯¸ì‘ë™ ==

=== ì›ì¸ 6-1: is_active=false ===

**ğŸ” ì§„ë‹¨:**

{{code language="sql"}}
-- ë¹„í™œì„± í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í™•ì¸
SELECT * FROM whitelist_ips WHERE is_active = false;
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="sql"}}
-- í™œì„±í™”
UPDATE whitelist_ips
SET is_active = true
WHERE ip_address = '192.168.1.100';

-- ì „ì²´ í™œì„±í™”
UPDATE whitelist_ips
SET is_active = true
WHERE is_active = false;
{{/code}}

=== ì›ì¸ 6-2: ìºì‹œ ë¬´íš¨í™” í•„ìš” ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Redis ìºì‹œ í™•ì¸
docker exec blacklist-redis redis-cli KEYS "ip:*"
docker exec blacklist-redis redis-cli GET "ip:192.168.1.100"
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# íŠ¹ì • IP ìºì‹œ ì‚­ì œ
docker exec blacklist-redis redis-cli DEL "ip:192.168.1.100"

# ì „ì²´ ìºì‹œ ì´ˆê¸°í™” (ì£¼ì˜!)
docker exec blacklist-redis redis-cli FLUSHDB
# ë˜ëŠ”
docker-compose restart blacklist-redis
{{/code}}

=== ì›ì¸ 6-3: DB ë™ê¸°í™” ë¬¸ì œ ===

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# ì•± ë¡œê·¸ì—ì„œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì²´í¬ í™•ì¸
docker-compose logs blacklist-app | grep "whitelist_hit"

# DB ì§ì ‘ í™•ì¸
docker exec blacklist-postgres psql -U postgres -d blacklist \
  -c "SELECT * FROM whitelist_ips WHERE ip_address = '192.168.1.100';"
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ì•± ì¬ì‹œì‘ìœ¼ë¡œ DB ì—°ê²° ì¬ì„¤ì •
docker-compose restart blacklist-app

# DB ì—°ê²° í’€ ì´ˆê¸°í™” (Python)
docker exec blacklist-app python3 << 'EOF'
from core.services.database_service import DatabaseService
db = DatabaseService.get_instance()
db.reset_connection_pool()
EOF
{{/code}}

---


//ì‘ì„±: ì •ë³´ë³´ì•ˆíŒ€//

----

== ğŸ’¬ Discussion ==

{{info}}
ì´ ë¬¸ì„œì— ëŒ€í•œ ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì´ ìˆìœ¼ì‹œë©´ ì•„ë˜ì— ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
{{/info}}

{{comment}}
ëŒ“ê¸€ì„ ì¶”ê°€í•˜ì„¸ìš”...
{{/comment}}

---

== ğŸš¨ ì¦ìƒ 7: Traefik ë¼ìš°íŒ… ì‹¤íŒ¨ ==

=== ì›ì¸ 7-1: Traefik ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}Network traefik-public declared as external, but could not be found{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Traefik ë„¤íŠ¸ì›Œí¬ ì¡´ì¬ í™•ì¸
docker network ls | grep -i traefik

# ë„¤íŠ¸ì›Œí¬ ìƒì„¸ ì •ë³´
docker network inspect traefik-public
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë°©ë²• 1: Traefik ë„¤íŠ¸ì›Œí¬ê°€ ì—†ëŠ” ê²½ìš° ìƒì„±
docker network create traefik-public

# ë°©ë²• 2: ë‹¤ë¥¸ ì´ë¦„ì˜ Traefik ë„¤íŠ¸ì›Œí¬ í™•ì¸
docker network ls | grep -i traefik
# ì˜ˆ: traefik-gateway ë°œê²¬ ì‹œ docker-compose.yml ìˆ˜ì •

# ë°©ë²• 3: ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker compose up -d
{{/code}}

=== ì›ì¸ 7-2: Traefik ë¼ë²¨ ì„¤ì • ì˜¤ë¥˜ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}https://blacklist.nxtd.co.kr{{/code}} ì ‘ì† ì‹œ 404 Not Found
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Traefik ë¡œê·¸ í™•ì¸
docker logs traefik | grep blacklist

# ë¼ìš°í„° ìƒì„± í™•ì¸
docker logs traefik | grep -E "Router.*blacklist"
# ì˜ˆìƒ ì¶œë ¥: "Router 'blacklist-https' created"

# v3.3.7: blacklist-frontend ì»¨í…Œì´ë„ˆ ë¼ë²¨ í™•ì¸ (nginx ì œê±°ë¨)
docker inspect blacklist-frontend | grep -A 20 Labels
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# docker-compose.yml ë¼ë²¨ ê²€ì¦
vi docker-compose.yml

# v3.3.7 í•„ìˆ˜ ë¼ë²¨ (blacklist-frontend ì„œë¹„ìŠ¤):
#   - traefik.enable=true
#   - traefik.docker.network=traefik-public
#   - traefik.http.routers.blacklist-https.rule=Host(`blacklist.nxtd.co.kr`)
#   - traefik.http.routers.blacklist-https.tls.certresolver=letsencrypt
#   - traefik.http.services.blacklist.loadbalancer.server.port=2543

# ìˆ˜ì • í›„ ì¬ë°°í¬
docker compose down
docker compose up -d

# Traefik ì¬ì‹œì‘ (ì„œë¹„ìŠ¤ ê°ì§€ ê°±ì‹ )
docker restart traefik
{{/code}}

=== ì›ì¸ 7-3: Let's Encrypt ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}https://blacklist.nxtd.co.kr{{/code}} ì ‘ì† ì‹œ SSL ì¸ì¦ì„œ ì˜¤ë¥˜
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Traefik acme.json í™•ì¸
docker exec traefik ls -la /letsencrypt/acme.json

# Traefik ë¡œê·¸ì—ì„œ ì¸ì¦ì„œ ë°œê¸‰ í™•ì¸
docker logs traefik | grep -E "ACME|certificate|blacklist.nxtd.co.kr"

# DNS ì„¤ì • í™•ì¸ (ì¤‘ìš”!)
nslookup blacklist.nxtd.co.kr
# ì˜ˆìƒ ì¶œë ¥: ì„œë²„ IP ì£¼ì†Œ (192.168.50.100 ë˜ëŠ” ê³µì¸ IP)
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë°©ë²• 1: DNS ì„¤ì • í™•ì¸
# - blacklist.nxtd.co.kr A ë ˆì½”ë“œ â†’ ì„œë²„ IP
# - í¬íŠ¸ 80, 443 ë°©í™”ë²½ ì˜¤í”ˆ í™•ì¸

# ë°©ë²• 2: Traefik ì¬ì‹œì‘ (ì¸ì¦ì„œ ì¬ë°œê¸‰ ì‹œë„)
docker restart traefik

# ë°©ë²• 3: acme.json ì´ˆê¸°í™” (ê¸°ì¡´ ì¸ì¦ì„œ ì‚­ì œ)
docker exec traefik rm /letsencrypt/acme.json
docker exec traefik touch /letsencrypt/acme.json
docker exec traefik chmod 600 /letsencrypt/acme.json
docker restart traefik

# ë°©ë²• 4: Let's Encrypt staging ì„œë²„ë¡œ í…ŒìŠ¤íŠ¸
# /home/jclee/infrastructure/traefik/docker-compose.ymlì—ì„œ:
#   - "--certificatesresolvers.letsencrypt.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory"

# ë°©ë²• 5: v3.3.7 Traefik ì„¤ì • í™•ì¸
# /home/jclee/infrastructure/traefik/config/dynamic.yml í™•ì¸
# ë¼ìš°í„°ê°€ ì˜¬ë°”ë¥¸ ë„ë©”ì¸(blacklist.nxtd.co.kr)ì„ ì‚¬ìš©í•˜ëŠ”ì§€ ê²€ì¦
{{/code}}

=== ì›ì¸ 7-4: Traefikê³¼ Frontend í†µì‹  ì‹¤íŒ¨ (NEW v3.3.7) ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: Traefik ë¡œê·¸ì— {{code}}Gateway Timeout{{/code}} ë˜ëŠ” {{code}}Service Unavailable{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Frontend ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker ps | grep blacklist-frontend

# Frontend í—¬ìŠ¤ì²´í¬
curl http://172.25.0.2:2543/health
# ë˜ëŠ” (ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ)
docker exec blacklist-frontend curl http://localhost:2543/

# Traefikì´ Frontendë¥¼ ë°œê²¬í–ˆëŠ”ì§€ í™•ì¸
docker logs traefik | grep frontend

# ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
docker network inspect traefik-public | grep blacklist-frontend
docker network inspect blacklist-network | grep blacklist-frontend
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# ë°©ë²• 1: Frontendê°€ ë‘ ë„¤íŠ¸ì›Œí¬ì— ëª¨ë‘ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
docker inspect blacklist-frontend | grep -A 10 Networks
# ì˜ˆìƒ: blacklist-network, traefik-public ëª¨ë‘ ë³´ì—¬ì•¼ í•¨

# ë°©ë²• 2: docker-compose.yml ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸
vi docker-compose.yml
# blacklist-frontend:
#   networks:
#     - blacklist-network
#     - traefik-public

# ë°©ë²• 3: ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²°
docker network disconnect traefik-public blacklist-frontend
docker network connect traefik-public blacklist-frontend

# ë°©ë²• 4: ì „ì²´ ì¬ë°°í¬
docker compose down
docker compose up -d

# ë°©ë²• 5: Frontend ë¡œê·¸ í™•ì¸ (Next.js ì—ëŸ¬)
docker logs blacklist-frontend
{{/code}}

---

== ğŸš¨ ì¦ìƒ 8: ë°ì´í„° ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ ì‹¤íŒ¨ ==

=== ì›ì¸ 8-1: Collector API ì—”ë“œí¬ì¸íŠ¸ ë¯¸êµ¬í˜„ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: {{code}}"message": "ì¸ì¦ ì‹¤íŒ¨: Collector API error: 404"{{/code}}
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# Collector ë¡œê·¸ í™•ì¸
docker logs blacklist-collector | grep -i "test-auth"

# Collector API ë¼ìš°íŠ¸ í™•ì¸
docker exec blacklist-collector ls -la /app/api/
docker exec blacklist-collector grep -r "test-auth" /app/

# API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
curl -X POST http://localhost:8545/api/test-auth/REGTECH
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# Collector APIì— /api/test-auth ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ í•„ìš”
# (ê°œë°œ ì‘ì—… í•„ìš”)

# ì„ì‹œ ëŒ€ì•ˆ: ì§ì ‘ credentials í…Œì´ë¸” í™•ì¸
docker exec blacklist-postgres psql -U postgres -d blacklist \
  -c "SELECT service_name, id, status FROM collection_credentials;"

# ìˆ˜ë™ìœ¼ë¡œ ì¸ì¦ í…ŒìŠ¤íŠ¸ (REGTECH)
docker exec blacklist-app python3 -c "
from collector.api.regtech_api import REGTECHCollector
collector = REGTECHCollector()
result = collector.authenticate()
print(result)
"
{{/code}}

---

== ğŸš¨ ì¦ìƒ 9: Git LFS íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ==

=== ì›ì¸ 9-1: CloudFlare 100MB ì œí•œ ===

{{warning}}
**ğŸ”´ ì¦ìƒ**: tar.gz íŒŒì¼ì´ 701MBê°€ ì•„ë‹Œ 134 bytes (LFS pointer íŒŒì¼)
{{/warning}}

**ğŸ” ì§„ë‹¨:**

{{code language="bash"}}
# íŒŒì¼ í¬ê¸° í™•ì¸
ls -lh offline-packages/*.tar.gz
# ì˜ˆìƒ: 701MB, ì‹¤ì œ: 134 bytes â†’ LFS ë¯¸ë‹¤ìš´ë¡œë“œ

# LFS íŒŒì¼ ìƒíƒœ í™•ì¸
git lfs ls-files
cat offline-packages/*.tar.gz | head -5
# "version https://git-lfs.github.com/spec/v1" â†’ pointer íŒŒì¼
{{/code}}

**âœ… í•´ê²° ë°©ë²•:**

{{code language="bash"}}
# CloudFlare ìš°íšŒ ì„¤ì • (DNS override)
sudo bash -c 'echo "221.153.20.249 git.jclee.me" >> /etc/hosts'

# SSL ê²€ì¦ ë¹„í™œì„±í™” (self-signed cert)
git config --global http.sslVerify false

# ì €ì¥ì†Œ ì¬í´ë¡  (LFS ë‹¤ìš´ë¡œë“œ)
GIT_SSL_NO_VERIFY=1 git clone --depth 1 ssh://git@git.jclee.me:2223/gitadmin/blacklist.git

# íŒŒì¼ ê²€ì¦
ls -lh blacklist/offline-packages/*.tar.gz
# ì˜ˆìƒ: ~701MB

sha256sum -c blacklist/offline-packages/*.sha256
# ì˜ˆìƒ: OK
{{/code}}

---

//ì‘ì„±: ì •ë³´ë³´ì•ˆíŒ€ - 2025-10-22 ì—…ë°ì´íŠ¸//
