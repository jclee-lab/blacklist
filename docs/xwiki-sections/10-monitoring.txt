= ğŸ“Š 10. Monitoring & Observability =

{{info}}
ì´ í˜ì´ì§€ëŠ” Grafana ëŒ€ì‹œë³´ë“œë¥¼ **ì‹¤ì‹œê°„ìœ¼ë¡œ ì„ë² ë“œ**í•©ë‹ˆë‹¤.
Synology NAS(grafana.jclee.me)ì— ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤.
{{/info}}

----

== Real-time Dashboards ==

=== Blacklist Statistics Dashboard ===

{{html}}
<div class="grafana-container">
  <div class="dashboard-header">
    <h3>ğŸ“ˆ Blacklist Statistics</h3>
    <p>ì‹¤ì‹œê°„ IP ì°¨ë‹¨ í†µê³„ ë° ì¶”ì„¸ ë¶„ì„</p>
    <a href="https://grafana.jclee.me/d/blacklist-stats" target="_blank" class="external-link">
      ğŸ”— ìƒˆ ì°½ì—ì„œ ì—´ê¸°
    </a>
  </div>

  <iframe
    src="https://grafana.jclee.me/d/blacklist-stats?orgId=1&refresh=10s&kiosk&theme=light"
    width="100%"
    height="600px"
    frameborder="0"
    class="grafana-iframe">
  </iframe>

  <div class="dashboard-info">
    <strong>í¬í•¨ëœ ë©”íŠ¸ë¦­:</strong>
    <ul>
      <li>Total Blacklist/Whitelist IPs</li>
      <li>IP Check Decision Rates</li>
      <li>Top 10 Countries</li>
      <li>Collection Success Rate</li>
    </ul>
  </div>
</div>
{{/html}}

----

=== System Health Dashboard ===

{{html}}
<div class="grafana-container">
  <div class="dashboard-header">
    <h3>ğŸ¥ System Health</h3>
    <p>ì»¨í…Œì´ë„ˆ ìƒíƒœ, CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ , ì‘ë‹µ ì‹œê°„</p>
    <a href="https://grafana.jclee.me/d/blacklist-health" target="_blank" class="external-link">
      ğŸ”— ìƒˆ ì°½ì—ì„œ ì—´ê¸°
    </a>
  </div>

  <iframe
    src="https://grafana.jclee.me/d/blacklist-health?orgId=1&refresh=10s&kiosk&theme=light"
    width="100%"
    height="600px"
    frameborder="0"
    class="grafana-iframe">
  </iframe>

  <div class="dashboard-info">
    <strong>í¬í•¨ëœ ë©”íŠ¸ë¦­:</strong>
    <ul>
      <li>Container Status (Up/Down)</li>
      <li>CPU & Memory Usage</li>
      <li>API Response Time (p50, p95, p99)</li>
      <li>Database Connection Pool</li>
    </ul>
  </div>
</div>
{{/html}}

----

=== Application Performance Dashboard ===

{{html}}
<div class="grafana-container">
  <div class="dashboard-header">
    <h3>âš¡ Application Performance</h3>
    <p>API ì„±ëŠ¥, ì²˜ë¦¬ëŸ‰, ì—ëŸ¬ìœ¨</p>
    <a href="https://grafana.jclee.me/d/blacklist-performance" target="_blank" class="external-link">
      ğŸ”— ìƒˆ ì°½ì—ì„œ ì—´ê¸°
    </a>
  </div>

  <iframe
    src="https://grafana.jclee.me/d/blacklist-performance?orgId=1&refresh=10s&kiosk&theme=light"
    width="100%"
    height="600px"
    frameborder="0"
    class="grafana-iframe">
  </iframe>

  <div class="dashboard-info">
    <strong>í¬í•¨ëœ ë©”íŠ¸ë¦­:</strong>
    <ul>
      <li>Requests per Second (RPS)</li>
      <li>Error Rate (5xx responses)</li>
      <li>API Latency Distribution</li>
      <li>Cache Hit Rate (Redis)</li>
    </ul>
  </div>
</div>

<style>
.grafana-container {
  margin: 30px 0;
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.dashboard-header {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 2px solid #0066cc;
}

.dashboard-header h3 {
  margin: 0 0 8px 0;
  color: #0066cc;
  font-size: 22px;
}

.dashboard-header p {
  margin: 0;
  color: #6c757d;
  font-size: 14px;
}

.external-link {
  display: inline-block;
  margin-top: 10px;
  padding: 8px 16px;
  background: #0066cc;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-size: 14px;
  transition: background 0.3s;
}

.external-link:hover {
  background: #0052a3;
}

.grafana-iframe {
  border: 2px solid #dee2e6;
  border-radius: 8px;
  background: white;
}

.dashboard-info {
  margin-top: 15px;
  padding: 15px;
  background: white;
  border-radius: 8px;
  border-left: 4px solid #28a745;
}

.dashboard-info strong {
  color: #28a745;
  font-size: 16px;
}

.dashboard-info ul {
  margin: 10px 0 0 0;
  padding-left: 20px;
}

.dashboard-info li {
  margin: 5px 0;
  color: #495057;
}
</style>
{{/html}}

----

== Prometheus Metrics ==

=== Key Metrics ===

{{code language="prometheus"}}
# Application Metrics
blacklist_decisions_total{decision="allowed_whitelist"}
blacklist_decisions_total{decision="allowed_not_found"}
blacklist_decisions_total{decision="blocked_blacklist"}
blacklist_whitelist_hits_total
blacklist_blacklist_hits_total

# API Performance
blacklist_api_requests_total
blacklist_api_request_duration_seconds_bucket
blacklist_api_errors_total

# Collection Metrics
blacklist_collection_duration_seconds
blacklist_collection_items_total
blacklist_collection_errors_total

# System Metrics
process_cpu_seconds_total
process_resident_memory_bytes
python_gc_objects_collected_total
{{/code}}

=== Metrics Endpoint ===

{{info}}
**v3.3.7 ì•„í‚¤í…ì²˜**: í¬íŠ¸ 2542ëŠ” ë‚´ë¶€ ì „ìš©ì…ë‹ˆë‹¤. ì™¸ë¶€ì—ì„œëŠ” Traefikë¥¼ í†µí•´ ì ‘ê·¼í•˜ê±°ë‚˜, ì„œë²„ ë‚´ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼í•˜ì„¸ìš”.
{{/info}}

{{code language="bash"}}
# v3.3.7: ë‚´ë¶€ ì ‘ê·¼ (ì„œë²„ SSH ì ‘ì† í›„)
curl http://172.25.0.3:2542/metrics
# ë˜ëŠ” localhost (ì»¨í…Œì´ë„ˆ ë‚´ë¶€)
docker exec blacklist-app curl http://localhost:2542/metrics

# v3.3.7: ì™¸ë¶€ ì ‘ê·¼ (Traefik proxy ì‚¬ìš©)
curl https://blacklist.nxtd.co.kr/metrics
# ì£¼ì˜: Traefik ë¼ìš°íŒ… ì„¤ì • í•„ìš”

# Filter specific metrics
curl http://172.25.0.3:2542/metrics | grep blacklist_decisions

# Prometheus scrape config (Synology NASì—ì„œ ìë™ ìˆ˜ì§‘)
curl https://prometheus.jclee.me/api/v1/targets | jq '.data.activeTargets[] | select(.labels.job=="blacklist")'
{{/code}}

----

== Loki Log Aggregation ==

=== Log Query Examples ===

{{panel}}
==== Application Logs ====

**ìµœê·¼ ì—ëŸ¬ ë¡œê·¸**:
{{code language="logql"}}
{job="blacklist-app"} |= "ERROR"
{{/code}}

**íŠ¹ì • IP ê²€ìƒ‰**:
{{code language="logql"}}
{job="blacklist-app"} |= "1.2.3.4" | json | ip_address="1.2.3.4"
{{/code}}

**Collection ì‹œì‘/ì¢…ë£Œ**:
{{code language="logql"}}
{job="blacklist-collector"} |~ "Collection (started|completed)"
{{/code}}

**API ì‘ë‹µ ì‹œê°„ ë¶„ì„**:
{{code language="logql"}}
{job="blacklist-app"} | json | response_time > 1000
{{/code}}
{{/panel}}

=== Log Levels ===

|= Level |= Color |= Usage |= Example Query
| DEBUG | Gray | ê°œë°œìš© ìƒì„¸ ë¡œê·¸ | {{code}}{job="blacklist"} \\|= "DEBUG"{{/code}}
| INFO | Blue | ì •ìƒ ìš´ì˜ ì •ë³´ | {{code}}{job="blacklist"} \\|= "INFO"{{/code}}
| WARNING | Yellow | ì£¼ì˜ í•„ìš” | {{code}}{job="blacklist"} \\|= "WARNING"{{/code}}
| ERROR | Red | ì˜¤ë¥˜ ë°œìƒ | {{code}}{job="blacklist"} \\|= "ERROR"{{/code}}
| CRITICAL | Dark Red | ì‹¬ê°í•œ ì˜¤ë¥˜ | {{code}}{job="blacklist"} \\|= "CRITICAL"{{/code}}

----

== Alerting Rules ==

=== Critical Alerts ===

{{warning}}
ë‹¤ìŒ ì¡°ê±´ì—ì„œ **ì¦‰ì‹œ ì•Œë¦¼**ì´ ë°œìƒí•©ë‹ˆë‹¤:
{{/warning}}

|= Alert Name |= Condition |= Severity |= Action
| **BlacklistServiceDown** | {{code}}up{job="blacklist-app"} == 0{{/code}} | Critical | ì¦‰ì‹œ ì¬ì‹œì‘
| **HighErrorRate** | {{code}}rate(blacklist_api_errors_total[5m]) > 10{{/code}} | Critical | ë¡œê·¸ í™•ì¸
| **CollectionFailure** | {{code}}blacklist_collection_errors_total > 0{{/code}} | High | REGTECH ì—°ê²° í™•ì¸
| **HighMemoryUsage** | {{code}}process_resident_memory_bytes > 2GB{{/code}} | High | ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ì¡°ì‚¬
| **DatabaseConnectionLoss** | {{code}}blacklist_db_connections{state="idle"} == 0{{/code}} | Critical | PostgreSQL ì¬ì‹œì‘

=== Warning Alerts ===

|= Alert Name |= Condition |= Severity |= Action
| **SlowResponseTime** | {{code}}histogram_quantile(0.95, ...) > 1s{{/code}} | Warning | ì„±ëŠ¥ ìµœì í™”
| **HighCacheMissRate** | {{code}}redis_cache_hit_rate < 0.8{{/code}} | Warning | ìºì‹œ ì „ëµ ê²€í† 
| **LowDiskSpace** | {{code}}node_filesystem_avail_bytes < 10GB{{/code}} | Warning | ë””ìŠ¤í¬ ì •ë¦¬

----

== Monitoring Best Practices ==

{{panel}}
=== 1. ëŒ€ì‹œë³´ë“œ í™œìš© ===

* **ë§¤ì¼ ì•„ì¹¨**: Health Dashboard í™•ì¸ (5ë¶„)
* **ë°°í¬ ì „í›„**: Performance Dashboard ë¹„êµ (10ë¶„)
* **ì£¼ê°„ ë¦¬ë·°**: Statistics Dashboard ì¶”ì„¸ ë¶„ì„ (30ë¶„)

=== 2. ì•Œë¦¼ ê´€ë¦¬ ===

* **Slack í†µí•©**: ëª¨ë“  Critical ì•Œë¦¼ â†’ #blacklist-alerts ì±„ë„
* **Email í†µí•©**: High ì•Œë¦¼ â†’ ìš´ì˜íŒ€ ë©”ì¼ë§ ë¦¬ìŠ¤íŠ¸
* **PagerDuty**: Critical ì•Œë¦¼ â†’ 24/7 ì˜¨ì½œ ì—”ì§€ë‹ˆì–´

=== 3. ë¡œê·¸ ë¶„ì„ ===

* **ì—ëŸ¬ ë¡œê·¸**: ë§¤ì¼ ë¦¬ë·°, íŒ¨í„´ ë¶„ì„
* **API ë¡œê·¸**: ëŠë¦° ì¿¼ë¦¬ ì‹ë³„ (>1s)
* **Collection ë¡œê·¸**: ì‹¤íŒ¨ ì›ì¸ ì¶”ì 

=== 4. ë©”íŠ¸ë¦­ ê¸°ë°˜ ì˜ì‚¬ê²°ì • ===

* **ìŠ¤ì¼€ì¼ ì•„ì›ƒ**: RPS > 1000ì¼ ë•Œ ì»¨í…Œì´ë„ˆ ì¶”ê°€
* **ìºì‹œ íŠœë‹**: Cache Hit Rate < 80%ì¼ ë•Œ ì „ëµ ë³€ê²½
* **DB ìµœì í™”**: Query Time > 500msì¼ ë•Œ ì¸ë±ìŠ¤ ì¶”ê°€
{{/panel}}

----

== Grafana Access ==

{{info}}
**Grafana URL**: https://grafana.jclee.me

**ë¡œê·¸ì¸ ì •ë³´**:
* Username: `admin`
* Password: `${GRAFANA_ADMIN_PASSWORD}` (Synology NAS í™˜ê²½ë³€ìˆ˜)

**ê¶Œí•œ**:
* **Viewer**: ëŒ€ì‹œë³´ë“œ ì¡°íšŒë§Œ ê°€ëŠ¥
* **Editor**: ëŒ€ì‹œë³´ë“œ ìˆ˜ì • ê°€ëŠ¥
* **Admin**: ëª¨ë“  ì„¤ì • ë³€ê²½ ê°€ëŠ¥
{{/info}}

----

== Troubleshooting ==

=== Grafanaì—ì„œ ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠìŒ ===

{{code language="bash"}}
# 1. Prometheusê°€ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ëŠ”ì§€ í™•ì¸
curl https://prometheus.jclee.me/api/v1/query?query=up{job="blacklist-app"}

# 2. v3.3.7: ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ (ë‚´ë¶€ ì ‘ê·¼)
curl http://172.25.0.3:2542/metrics
# ë˜ëŠ” ì„œë²„ì—ì„œ
ssh user@192.168.50.100
curl http://localhost:2542/metrics

# 3. Prometheus ì„¤ì • í™•ì¸ (Synology NAS)
ssh admin@192.168.50.215
cat /volume1/docker/grafana/configs/prometheus.yml | grep blacklist
# í™•ì¸: Prometheusê°€ blacklist-app:2542ë¥¼ scrapeí•˜ëŠ”ì§€ ê²€ì¦
{{/code}}

=== ì„ë² ë“œëœ Dashboardê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ ===

* **ì›ì¸ 1**: Synology NAS (192.168.50.215) ë„¤íŠ¸ì›Œí¬ ë¶ˆê°€
  * **í•´ê²°**: `ping 192.168.50.215` í…ŒìŠ¤íŠ¸
* **ì›ì¸ 2**: Grafana ì„œë¹„ìŠ¤ ì¤‘ë‹¨
  * **í•´ê²°**: SSHë¡œ Synology ì ‘ì† â†’ `docker ps | grep grafana`
* **ì›ì¸ 3**: ë¸Œë¼ìš°ì € iframe ì°¨ë‹¨
  * **í•´ê²°**: ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ iframe í—ˆìš©

=== Loki ë¡œê·¸ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ ===

{{code language="bash"}}
# 1. Promtailì´ ë¡œê·¸ë¥¼ ì „ì†¡í•˜ëŠ”ì§€ í™•ì¸
docker logs blacklist-app | tail -20

# 2. Loki ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
curl -G -s "https://loki.jclee.me/loki/api/v1/query_range" \
  --data-urlencode 'query={job="blacklist-app"}' | jq

# 3. Promtail ì„¤ì • í™•ì¸ (ë¡œì»¬ ë˜ëŠ” Synology)
cat /etc/promtail/config.yml
{{/code}}

----

== Performance Optimization Tips ==

{{success}}
**ìµœì í™” íŒ**:

1. **Dashboard Refresh Rate**: ì‹¤ì‹œê°„(10s) â†’ í•„ìš”ì‹œë§Œ(30s)
2. **Query Time Range**: ê¸°ë³¸ 6ì‹œê°„ â†’ í•„ìš”í•œ ë²”ìœ„ë§Œ ì„ íƒ
3. **Panel ìˆ˜ ìµœì†Œí™”**: ë„ˆë¬´ ë§ì€ íŒ¨ë„ì€ ë¸Œë¼ìš°ì € ë¶€í•˜
4. **Alert ì •ë¦¬**: ë¶ˆí•„ìš”í•œ ì•Œë¦¼ ë¹„í™œì„±í™”
{{/success}}

----

{{success}}
**Monitoring Stack v3.3.7**
Synology NAS ê¸°ë°˜ ì¤‘ì•™ ì§‘ì¤‘ì‹ ëª¨ë‹ˆí„°ë§
* Blacklist System: v3.3.7 (Traefik ì•„í‚¤í…ì²˜)
* Grafana: 10.2.3
* Prometheus: 2.48.1
* Loki: 2.9.3
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: 2025-10-29
{{/success}}

----

== ğŸ’¬ Discussion ==

{{info}}
ì´ ë¬¸ì„œì— ëŒ€í•œ ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì´ ìˆìœ¼ì‹œë©´ ì•„ë˜ì— ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
{{/info}}

{{comment}}
ëŒ“ê¸€ì„ ì¶”ê°€í•˜ì„¸ìš”...
{{/comment}}
