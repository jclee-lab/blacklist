
= ğŸ“Š Mermaid Diagrams Collection =

{{info}}
ì´ í˜ì´ì§€ëŠ” PlantUML ë‹¤ì´ì–´ê·¸ë¨ì˜ Mermaid ë²„ì „ì…ë‹ˆë‹¤.
XWiki Mermaid Extension ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.
{{/info}}

----

== 1. System Architecture ==

{{mermaid}}
graph TB
    subgraph "External Layer"
        User[User/Client]
        Traefik[Traefik Reverse Proxy<br/>Port 80/443]
    end

    subgraph "Application Layer"
        App[blacklist-app<br/>Flask + Gunicorn<br/>Port 2542]
        Collector[blacklist-collector<br/>Data Collection Service<br/>Port 8545]
    end

    subgraph "Data Layer"
        Postgres[(PostgreSQL 15<br/>Port 5432)]
        Redis[(Redis 7<br/>Port 6379)]
    end

    subgraph "Monitoring Stack"
        Prometheus[Prometheus<br/>Synology NAS]
        Grafana[Grafana<br/>grafana.jclee.me]
        Loki[Loki<br/>Log Aggregation]
    end

    subgraph "External Services"
        REGTECH[REGTECH Portal<br/>Data Source]
    end

    User -->|HTTPS| Traefik
    Traefik -->|HTTP| App
    App -->|SQL| Postgres
    App -->|Cache| Redis
    App -->|/metrics| Prometheus
    App -->|Logs| Loki

    Collector -->|Scheduled| REGTECH
    Collector -->|Batch Insert| Postgres
    Collector -->|/metrics| Prometheus

    Prometheus --> Grafana
    Loki --> Grafana

    style App fill:#4A90E2,color:#fff
    style Collector fill:#50C878,color:#fff
    style Postgres fill:#336791,color:#fff
    style Redis fill:#DC382D,color:#fff
    style Traefik fill:#37A4C0,color:#fff
    style Grafana fill:#F46800,color:#fff
{{/mermaid}}

----

== 2. IP Check Priority Logic ==

{{mermaid}}
flowchart TD
    Start([IP Check Request]) --> Whitelist{Whitelist<br/>Check}

    Whitelist -->|Found| AllowWL[âœ… Allow<br/>Reason: whitelist]
    Whitelist -->|Not Found| Blacklist{Blacklist<br/>Check}

    Blacklist -->|Not Found| AllowNF[âœ… Allow<br/>Reason: not_in_blacklist]
    Blacklist -->|Found| Active{is_active<br/>& removal_date}

    Active -->|Active & Valid| Block[ğŸš« Block<br/>Reason: blacklisted]
    Active -->|Inactive or Expired| AllowExp[âœ… Allow<br/>Reason: expired]

    AllowWL --> End([Response])
    AllowNF --> End
    Block --> End
    AllowExp --> End

    style Start fill:#4A90E2,color:#fff
    style AllowWL fill:#28A745,color:#fff
    style AllowNF fill:#28A745,color:#fff
    style AllowExp fill:#FFC107,color:#000
    style Block fill:#DC3545,color:#fff
    style End fill:#6C757D,color:#fff
{{/mermaid}}

----

== 3. Data Collection Flow ==

{{mermaid}}
sequenceDiagram
    participant User
    participant API as Blacklist API
    participant Collector
    participant REGTECH as REGTECH Portal
    participant DB as PostgreSQL

    User->>API: POST /api/collection/regtech/trigger
    API->>Collector: Async trigger collection
    API-->>User: 202 Accepted (Collection started)

    Collector->>DB: SELECT credentials
    DB-->>Collector: REGTECH_ID, REGTECH_PW

    Collector->>REGTECH: POST /findOneMember
    REGTECH-->>Collector: 200 OK (User found)

    Collector->>REGTECH: POST /addLogin
    REGTECH-->>Collector: 200 OK (Session cookie)

    loop Each page (50 pages)
        Collector->>REGTECH: GET Excel file
        REGTECH-->>Collector: Excel data (2000 rows)
        Collector->>Collector: Parse Excel (pandas/openpyxl)
        Collector->>DB: Batch INSERT (ON CONFLICT UPDATE)
    end

    Collector->>DB: INSERT collection_history
    DB-->>Collector: Record saved

    Collector-->>API: Collection complete (99,784 IPs)
    API->>User: WebSocket notification
{{/mermaid}}

----

== 4. Database Schema (ERD) ==

{{mermaid}}
erDiagram
    WHITELIST_IPS ||--o{ MANUAL_ADDITIONS : "priority_check"
    BLACKLIST_IPS ||--o{ FORTINET_ACTIVE_IPS : "active_ips"
    COLLECTION_CREDENTIALS ||--o{ COLLECTION_HISTORY : "uses"

    WHITELIST_IPS {
        bigserial id PK
        inet ip_address UK "VIP IP"
        varchar country "ISO 3166-1"
        text reason "Why whitelisted"
        timestamp created_at
        boolean is_active "Default: true"
    }

    BLACKLIST_IPS {
        bigserial id PK
        inet ip_address UK "Threat IP"
        varchar country "ISO 3166-1"
        text reason "Detection reason"
        date detection_date
        date removal_date "Auto-deactivate"
        jsonb raw_data "Original Excel row"
        boolean is_active "Auto-managed"
        timestamp created_at
        timestamp updated_at
    }

    COLLECTION_CREDENTIALS {
        bigserial id PK
        varchar service_name UK "REGTECH/Other"
        varchar username "Encrypted"
        varchar password "Encrypted"
        jsonb metadata "Extra config"
        timestamp created_at
        timestamp updated_at
    }

    COLLECTION_HISTORY {
        bigserial id PK
        varchar service_name FK
        timestamp collection_date
        integer items_collected
        integer items_inserted
        integer items_updated
        boolean success
        text error_message
        interval duration
    }
{{/mermaid}}

----

== 5. Deployment Pipeline ==

{{mermaid}}
flowchart LR
    subgraph "Development"
        Dev[Developer]
        Git[Git Push]
    end

    subgraph "CI/CD (GitHub Actions)"
        Build[Docker Build]
        Test[Run Tests]
        Push[Push to Registry]
    end

    subgraph "Deployment"
        Portainer[Portainer API]
        Deploy[Force Update]
        Health[Health Check]
    end

    subgraph "Production"
        Container[Running Container]
        Monitor[Grafana Monitoring]
    end

    Dev -->|git push master| Git
    Git -->|Trigger| Build
    Build --> Test
    Test -->|Success| Push
    Push -->|registry.jclee.me| Portainer
    Portainer --> Deploy
    Deploy --> Health
    Health -->|Healthy| Container
    Container --> Monitor
    Health -->|Unhealthy| Deploy

    style Build fill:#4A90E2,color:#fff
    style Test fill:#28A745,color:#fff
    style Deploy fill:#FFC107,color:#000
    style Container fill:#50C878,color:#fff
    style Monitor fill:#F46800,color:#fff
{{/mermaid}}

----

== 6. API Request State Machine ==

{{mermaid}}
stateDiagram-v2
    [*] --> Received: API Request

    Received --> Validating: Check Input
    Validating --> Whitelisted: Valid IP
    Validating --> Error: Invalid Input

    Whitelisted --> Allowed: In Whitelist
    Whitelisted --> CheckingBlacklist: Not in Whitelist

    CheckingBlacklist --> Blocked: In Blacklist (Active)
    CheckingBlacklist --> Allowed: Not in Blacklist
    CheckingBlacklist --> Allowed: In Blacklist (Expired)

    Allowed --> LogMetric: Record Decision
    Blocked --> LogMetric: Record Decision
    Error --> LogMetric: Record Error

    LogMetric --> [*]: Response Sent
{{/mermaid}}

----

== 7. Container Network Topology ==

{{mermaid}}
graph TB
    subgraph Internet
        Client[External Client]
    end

    subgraph "traefik-public (External Network)"
        Traefik[Traefik]
    end

    subgraph "blacklist-network (Internal Network)<br/>172.25.0.0/16"
        App[blacklist-app<br/>172.25.0.2]
        Collector[blacklist-collector<br/>172.25.0.3]
        Postgres[blacklist-postgres<br/>172.25.0.4]
        Redis[blacklist-redis<br/>172.25.0.5]
    end

    Client -->|HTTPS| Traefik
    Traefik -->|HTTP| App

    App ---|Internal DNS| Postgres
    App ---|Internal DNS| Redis
    Collector ---|Internal DNS| Postgres

    style Traefik fill:#37A4C0,color:#fff
    style App fill:#4A90E2,color:#fff
    style Collector fill:#50C878,color:#fff
    style Postgres fill:#336791,color:#fff
    style Redis fill:#DC382D,color:#fff
{{/mermaid}}

----

== 8. Authentication Flow (REGTECH) ==

{{mermaid}}
sequenceDiagram
    participant C as Collector
    participant R as REGTECH Portal
    participant DB as PostgreSQL

    Note over C,R: Phase 1: Member Validation
    C->>R: POST /findOneMember<br/>{id, name, birth}
    R-->>C: 200 OK<br/>{success: true}

    Note over C,R: Phase 2: Login
    C->>R: POST /addLogin<br/>{id, password}
    R-->>C: 200 OK + Set-Cookie<br/>(Session established)

    Note over C,R: Phase 3: Data Access
    loop 50 pages
        C->>R: GET /excel?page=N<br/>Cookie: session_id
        R-->>C: Excel file (2000 IPs)
        C->>C: Parse with pandas
        C->>DB: Batch INSERT
    end

    Note over C: Phase 4: Audit
    C->>DB: INSERT collection_history<br/>(success, duration, count)
{{/mermaid}}

----

== 9. Performance Metrics Collection ==

{{mermaid}}
flowchart LR
    subgraph "Application"
        App[blacklist-app]
        Metrics[/metrics Endpoint]
    end

    subgraph "Monitoring (Synology)"
        Prom[Prometheus<br/>Scrape every 15s]
        Loki[Loki<br/>Log aggregation]
        Grafana[Grafana<br/>Visualization]
    end

    App -->|Expose| Metrics
    App -->|Docker logs| Loki

    Prom -->|HTTP GET| Metrics
    Prom -->|Store| Grafana
    Loki -->|Store| Grafana

    Grafana -->|Dashboard| User[User]

    style App fill:#4A90E2,color:#fff
    style Prom fill:#E6522C,color:#fff
    style Loki fill:#00A6A6,color:#fff
    style Grafana fill:#F46800,color:#fff
{{/mermaid}}

----

== 10. Docker Image Build & Deploy ==

{{mermaid}}
flowchart TB
    subgraph "Source Code"
        Repo[GitHub Repository]
        Dockerfile[Dockerfile]
    end

    subgraph "Build Process"
        Base[Base Image<br/>python:3.11-slim]
        Deps[Install Dependencies]
        Copy[Copy Application]
        Final[Final Image]
    end

    subgraph "Registry"
        Registry[registry.jclee.me]
    end

    subgraph "Deployment"
        Pull[Pull Image]
        Run[Run Container]
        Health[Health Check]
    end

    Repo --> Dockerfile
    Dockerfile --> Base
    Base --> Deps
    Deps --> Copy
    Copy --> Final
    Final -->|Push| Registry
    Registry -->|Pull| Pull
    Pull --> Run
    Run --> Health
    Health -->|Pass| Running[âœ… Running]
    Health -->|Fail| Rollback[âš ï¸ Rollback]

    style Base fill:#4A90E2,color:#fff
    style Final fill:#50C878,color:#fff
    style Registry fill:#FFC107,color:#000
    style Running fill:#28A745,color:#fff
    style Rollback fill:#DC3545,color:#fff
{{/mermaid}}

----

{{success}}
âœ… Mermaid ë‹¤ì´ì–´ê·¸ë¨ 10ê°œ ì¤€ë¹„ ì™„ë£Œ
{{/success}}

{{info}}
**XWiki Mermaid Extension ì„¤ì¹˜ ë°©ë²•:**
1. Administration â†’ Extensions
2. ê²€ìƒ‰: "Mermaid Macro"
3. Install í´ë¦­
4. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
{{/info}}
