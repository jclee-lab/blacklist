= (% id="H6" %)ğŸ” 6. ë³´ì•ˆ ì„¤ì • =

{{panel title="**âœ¨ ì´ ì„¹ì…˜ì—ì„œ ë°°ìš¸ ë‚´ìš©**"}}
* â˜‘ï¸ **Phase 1.3 ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ** (CSRF, Rate Limiting, Security Headers)
* â˜‘ï¸ **Input Validation** (SQL Injection ë°©ì–´, íŒŒë¼ë¯¸í„° ê²€ì¦)
* â˜‘ï¸ ë°©í™”ë²½ ê·œì¹™ (firewalld, iptables, Traefik)
* â˜‘ï¸ SELinux ì„¤ì •
* â˜‘ï¸ PostgreSQL ì ‘ê·¼ ì œì–´ (pg_hba.conf)
* â˜‘ï¸ Redis ë³´ì•ˆ ê°•í™”
* â˜‘ï¸ Docker ì»¨í…Œì´ë„ˆ ê²©ë¦¬
{{/panel}}

---

== 1ï¸âƒ£ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ (Phase 1.3) ==

{{success}}
**ğŸ†• 2025-10-22 ì¶”ê°€**: Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ ë³´ì•ˆ ê°•í™”
{{/success}}

=== ğŸ›¡ï¸  CSRF ë³´í˜¸ (Flask-WTF) ===

{{info}}
**Cross-Site Request Forgery (CSRF) ë°©ì–´**
* ëª¨ë“  ìƒíƒœ ë³€ê²½ ìš”ì²­(POST, PUT, DELETE)ì— CSRF í† í° ìš”êµ¬
* Read-only ì—”ë“œí¬ì¸íŠ¸(`/health`, `/metrics`) ì œì™¸
* Token rotation ìë™ ê´€ë¦¬
{{/info}}

{{code language="python"}}
# app/core/app.py::create_app()

from flask_wtf.csrf import CSRFProtect

app = Flask(__name__)
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', secrets.token_hex(32))

# CSRF ë³´í˜¸ í™œì„±í™”
csrf = CSRFProtect(app)

# Read-only ì—”ë“œí¬ì¸íŠ¸ ì œì™¸
@app.before_request
def csrf_protect():
    if request.method in ['GET', 'HEAD', 'OPTIONS']:
        return
    if request.path in ['/health', '/metrics']:
        return
    # ìë™ìœ¼ë¡œ CSRF í† í° ê²€ì¦
{{/code}}

**í…ŒìŠ¤íŠ¸ (tests/security/test_security.py):**

{{code language="python"}}
@pytest.mark.security
def test_csrf_missing_token(client):
    """CSRF í† í° ì—†ì´ POST ìš”ì²­ ì‹œ ê±°ë¶€"""
    response = client.post("/api/blacklist/manual-add",
                          json={"ip": "1.2.3.4"})
    assert response.status_code == 400  # CSRF token missing
{{/code}}

=== â±ï¸  Rate Limiting (Flask-Limiter) ===

{{info}}
**API ë‚¨ìš© ë°©ì§€**
* ê¸€ë¡œë²Œ ì œí•œ: 200 requests/day, 50 requests/hour
* Redis ë°±ì—”ë“œë¡œ ë¶„ì‚° í™˜ê²½ ì§€ì›
* X-RateLimit-* í—¤ë” ìë™ ì¶”ê°€
* localhost/Docker ë„¤íŠ¸ì›Œí¬ ì œì™¸ (172.*.*.*)
{{/info}}

{{code language="python"}}
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    storage_uri=f"redis://{redis_host}:6379",
    default_limits=["200 per day", "50 per hour"]
)

# íŠ¹ì • IP ì œì™¸ (localhost, Docker network)
limiter.exempt(lambda: request.remote_addr in ['127.0.0.1', '::1']
                or request.remote_addr.startswith('172.'))
{{/code}}

**í…ŒìŠ¤íŠ¸ (tests/security/test_security.py):**

{{code language="python"}}
@pytest.mark.security
def test_rate_limit_enforcement(client):
    """Rate limit ì´ˆê³¼ ì‹œ 429 ë°˜í™˜"""
    for _ in range(51):  # Exceed 50/hour limit
        client.get("/api/blacklist/check?ip=1.2.3.4")

    response = client.get("/api/blacklist/check?ip=1.2.3.4")
    assert response.status_code == 429  # Too Many Requests
{{/code}}

=== ğŸ”’ Security Headers Middleware ===

{{info}}
**ë¸Œë¼ìš°ì € ë³´ì•ˆ í—¤ë” ìë™ ì¶”ê°€**
* `X-Frame-Options: DENY` - Clickjacking ë°©ì§€
* `Content-Security-Policy` - XSS ë°©ì§€
* `X-Content-Type-Options: nosniff` - MIME ìŠ¤ë‹ˆí•‘ ë°©ì§€
* `Referrer-Policy: strict-origin-when-cross-origin`
{{/info}}

{{code language="python"}}
@app.after_request
def set_security_headers(response):
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['Content-Security-Policy'] = "default-src 'self'"
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'
    return response
{{/code}}

=== ğŸ” Input Validation (SQL Injection ë°©ì–´) ===

{{warning}}
**ì ˆëŒ€ ê¸ˆì§€**: ì‚¬ìš©ì ì…ë ¥ì„ ì§ì ‘ SQL ë¬¸ìì—´ì— ì‚½ì…
{{/warning}}

{{code language="python"}}
# âŒ ì·¨ì•½í•œ ì½”ë“œ (SQL Injection ê°€ëŠ¥)
query = f"SELECT * FROM blacklist_ips WHERE ip_address = '{user_input}'"

# âœ… ì•ˆì „í•œ ì½”ë“œ (Parameterized Query)
cursor.execute(
    "SELECT * FROM blacklist_ips WHERE ip_address = %s",
    (user_input,)  # íŒŒë¼ë¯¸í„° ë°”ì¸ë”©
)
{{/code}}

**í…ŒìŠ¤íŠ¸ (tests/security/test_security.py):**

{{code language="python"}}
@pytest.mark.security
def test_sql_injection_blocked(client):
    """SQL Injection ì‹œë„ ì°¨ë‹¨"""
    malicious_ip = "1.2.3.4'; DROP TABLE blacklist_ips; --"
    response = client.post("/api/blacklist/check",
                          json={"ip": malicious_ip})
    # SQL ì‹¤í–‰ë˜ì§€ ì•Šê³  validation error ë°˜í™˜
    assert response.status_code in [400, 422]
{{/code}}

---

== 2ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (Traefik + ë°©í™”ë²½) ==

{{info}}
**ğŸ—ï¸ v3.3.7 ì•„í‚¤í…ì²˜**:
* **ì™¸ë¶€ ì ‘ê·¼**: Traefik (í¬íŠ¸ 80/443) â†’ blacklist-frontend:2543
* **ë‚´ë¶€ í†µì‹ **: blacklist-network (172.25.0.0/16)
* **ë‚´ë¶€ í¬íŠ¸**: 2543 (Frontend), 2542 (API) - ì™¸ë¶€ ë…¸ì¶œ ë¶ˆí•„ìš”
{{/info}}

=== ğŸŒ Traefik ë³´ì•ˆ ì„¤ì • (NEW v3.3.7) ===

{{code language="yaml"}}
# /home/jclee/infrastructure/traefik/config/dynamic.yml

http:
  routers:
    blacklist:
      rule: "Host(`blacklist.nxtd.co.kr`)"
      entryPoints:
        - https
      service: blacklist
      tls:
        certResolver: letsencrypt
        options: modern
      middlewares:
        - secure-headers
        - rate-limit

  middlewares:
    secure-headers:
      headers:
        sslRedirect: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"

    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1m

  services:
    blacklist:
      loadBalancer:
        servers:
          - url: "http://blacklist-frontend:2543"

tls:
  options:
    modern:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
{{/code}}

**ğŸ“‹ Traefik ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
- [ ] âœ… Dashboard ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨ (ë˜ëŠ” Basic Auth)
- [ ] âœ… Let's Encrypt ìë™ ì¸ì¦ì„œ ê°±ì‹ 
- [ ] âœ… TLS 1.2+ ê°•ì œ
- [ ] âœ… Rate limiting í™œì„±í™” (100 req/min)
- [ ] âœ… Security headers ì ìš© (HSTS, X-Frame-Options)
- [ ] âœ… traefik-public ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬

=== ğŸ”¥ firewalld (RHEL 8.8) ===

{{info}}
**ğŸ¯ v3.3.7 í¬íŠ¸ ì „ëµ**: ì™¸ë¶€ëŠ” Traefik(80/443)ë§Œ ì˜¤í”ˆ, ë‚´ë¶€ í¬íŠ¸(2543/2542)ëŠ” Docker ë„¤íŠ¸ì›Œí¬ ì „ìš©
{{/info}}

{{code language="bash"}}
# ğŸ”“ ì™¸ë¶€ ì ‘ê·¼ìš© í¬íŠ¸ (Traefikë§Œ)
firewall-cmd --permanent --add-port=443/tcp   # HTTPS
firewall-cmd --permanent --add-port=80/tcp    # HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
firewall-cmd --reload

# âš ï¸ ë‚´ë¶€ í¬íŠ¸ëŠ” ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€
# í¬íŠ¸ 2543 (Frontend), 2542 (API)ëŠ” blacklist-network ì „ìš©
# ë°©í™”ë²½ ê·œì¹™ ì—†ìŒ = ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨ë¨

# ğŸ”’ ê´€ë¦¬ì IPë§Œ SSH í—ˆìš© (ì„ íƒì )
firewall-cmd --permanent --add-rich-rule='
  rule family="ipv4"
  source address="192.168.50.0/24"
  port port="22" protocol="tcp" accept'

firewall-cmd --reload

# âœ… í™•ì¸ (80, 443ë§Œ ì˜¤í”ˆë˜ì–´ì•¼ í•¨)
firewall-cmd --list-all
{{/code}}

=== ğŸ›¡ï¸  iptables (Ubuntu) ===

{{code language="bash"}}
# ğŸ”’ ê¸°ë³¸ ì •ì±…: ëª¨ë‘ ì°¨ë‹¨
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# âœ… ë¡œì»¬ ë£¨í”„ë°± í—ˆìš©
iptables -A INPUT -i lo -j ACCEPT

# ğŸ”„ ê¸°ì¡´ ì—°ê²° ìœ ì§€
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# ğŸ”“ v3.3.7: ì™¸ë¶€ ì ‘ê·¼ í¬íŠ¸ (Traefikë§Œ)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT   # SSH
iptables -A INPUT -p tcp --dport 443 -j ACCEPT  # HTTPS (Traefik)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT   # HTTP (Traefik)

# âš ï¸ ë‚´ë¶€ í¬íŠ¸ ì°¨ë‹¨ (2543, 2542)
# Docker ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
# ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨ë¨ (ë°©í™”ë²½ ê·œì¹™ ì—†ìŒ)

# ğŸŒ ê´€ë¦¬ì IPë§Œ SSH í—ˆìš© (ì„ íƒì )
iptables -I INPUT -p tcp -s 192.168.50.0/24 --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j DROP

# ğŸ’¾ ì €ì¥
iptables-save > /etc/iptables/rules.v4

# âœ… í™•ì¸
iptables -L -n -v
{{/code}}

---

== 2ï¸âƒ£ SELinux ì„¤ì • ==

{{success}}
**âœ… Enforcing ëª¨ë“œ ê¶Œì¥**: ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•´ SELinuxëŠ” í™œì„±í™” ìƒíƒœ ìœ ì§€
{{/success}}

{{code language="bash"}}
# ğŸ” SELinux ëª¨ë“œ í™•ì¸
getenforce  # ì˜ˆìƒ: Enforcing

# ğŸ³ Docker ì»¨í…Œì´ë„ˆ SELinux ê¶Œí•œ ë¶€ì—¬
semanage port -a -t http_port_t -p tcp 2542
semanage port -a -t http_port_t -p tcp 2543

# âœ… ì»¨í…Œì´ë„ˆ cgroup ê´€ë¦¬ í—ˆìš©
setsebool -P container_manage_cgroup on

# ğŸŒ ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ í—ˆìš©
setsebool -P container_connect_any on

# ğŸ“‹ ê°ì‚¬ ë¡œê·¸ í™•ì¸ (ë¬¸ì œ ë°œìƒ ì‹œ)
ausearch -m avc -ts recent | grep blacklist

# ğŸ”§ í•„ìš” ì‹œ ì •ì±… ìƒì„±
ausearch -m avc -ts recent | audit2allow -M blacklist_policy
semodule -i blacklist_policy.pp
{{/code}}

---

== 3ï¸âƒ£ PostgreSQL ì ‘ê·¼ ì œì–´ ==

=== ğŸ“ pg_hba.conf ì„¤ì • ===

{{warning}}
**âš ï¸ ì¤‘ìš”**: ì™¸ë¶€ ì ‘ê·¼ì„ ì™„ì „íˆ ì°¨ë‹¨í•˜ê³  Docker ë„¤íŠ¸ì›Œí¬ë§Œ í—ˆìš©
{{/warning}}

{{code language="text"}}
# /var/lib/postgresql/data/pg_hba.conf

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# ë¡œì»¬ Unix ì†Œì¼“ (ì‹ ë¢°)
local   all             postgres                                peer

# Docker ë„¤íŠ¸ì›Œí¬ë§Œ í—ˆìš© (172.25.0.0/16)
host    blacklist       postgres        172.25.0.0/16           scram-sha-256

# ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨ (ALL REJECT)
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject
{{/code}}

**ğŸ”§ ì ìš© ë°©ë²•:**

{{code language="bash"}}
# 1ï¸âƒ£ íŒŒì¼ ìˆ˜ì • (ì»¨í…Œì´ë„ˆ ë‚´ë¶€)
docker exec -it blacklist-postgres bash
vi /var/lib/postgresql/data/pg_hba.conf

# 2ï¸âƒ£ PostgreSQL ì¬ì‹œì‘
docker-compose restart blacklist-postgres

# 3ï¸âƒ£ ì„¤ì • í™•ì¸
docker exec blacklist-postgres psql -U postgres -c "SHOW hba_file;"
docker exec blacklist-postgres psql -U postgres -c "SELECT * FROM pg_hba_file_rules;"

# 4ï¸âƒ£ ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨ í…ŒìŠ¤íŠ¸
psql -h <ì„œë²„IP> -U postgres -d blacklist
# ì˜ˆìƒ ê²°ê³¼: connection rejected
{{/code}}

=== ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ì •ì±… ===

{{code language="sql"}}
-- PostgreSQL ë³´ì•ˆ ê°•í™”

-- 1ï¸âƒ£ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” (scram-sha-256)
ALTER SYSTEM SET password_encryption = 'scram-sha-256';

-- 2ï¸âƒ£ ì—°ê²° ì œí•œ
ALTER SYSTEM SET max_connections = 100;

-- 3ï¸âƒ£ ìœ íœ´ ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ (10ë¶„)
ALTER SYSTEM SET idle_in_transaction_session_timeout = '10min';

-- 4ï¸âƒ£ ëª…ë ¹ë¬¸ íƒ€ì„ì•„ì›ƒ (5ë¶„)
ALTER SYSTEM SET statement_timeout = '300s';

-- 5ï¸âƒ£ SSL ì—°ê²° ê°•ì œ (ì„ íƒì )
ALTER SYSTEM SET ssl = on;
ALTER SYSTEM SET ssl_cert_file = '/etc/ssl/certs/postgresql.crt';
ALTER SYSTEM SET ssl_key_file = '/etc/ssl/private/postgresql.key';

-- âœ… ì„¤ì • ì ìš©
SELECT pg_reload_conf();

-- ğŸ“Š í˜„ì¬ ì„¤ì • í™•ì¸
SHOW password_encryption;
SHOW max_connections;
SHOW idle_in_transaction_session_timeout;
{{/code}}

---

== 4ï¸âƒ£ Redis ë³´ì•ˆ ==

=== ğŸ” redis.conf ì„¤ì • ===

{{code language="text"}}
# /etc/redis/redis.conf

# 1ï¸âƒ£ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
requirepass your_strong_redis_password_here_32_chars

# 2ï¸âƒ£ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ ë°”ì¸ë”©
bind 172.25.0.6

# 3ï¸âƒ£ Protected mode í™œì„±í™”
protected-mode yes

# 4ï¸âƒ£ ìœ„í—˜í•œ ëª…ë ¹ì–´ ë¹„í™œì„±í™”
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN SHUTDOWN_SECRET_KEY_12345

# 5ï¸âƒ£ ìµœëŒ€ ë©”ëª¨ë¦¬ ì œí•œ (2GB)
maxmemory 2gb
maxmemory-policy allkeys-lru

# 6ï¸âƒ£ ë¡œê·¸ ì„¤ì •
loglevel notice
logfile /var/log/redis/redis-server.log

# 7ï¸âƒ£ ìŠ¤ëƒ…ìƒ· ë¹„í™œì„±í™” (ì„ íƒì  - ë°ì´í„° ì˜ì†ì„± ë¶ˆí•„ìš” ì‹œ)
save ""

# 8ï¸âƒ£ AOF ë¹„í™œì„±í™” (ìºì‹œ ìš©ë„)
appendonly no
{{/code}}

**ğŸ”§ ì ìš© ë°©ë²•:**

{{code language="bash"}}
# 1ï¸âƒ£ redis.conf í˜¸ìŠ¤íŠ¸ì— ìƒì„±
mkdir -p /opt/blacklist-config
vi /opt/blacklist-config/redis.conf
# ìœ„ ì„¤ì • ë‚´ìš© ë¶™ì—¬ë„£ê¸°

# 2ï¸âƒ£ docker-compose.ymlì— ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì¶”ê°€
# blacklist-redis:
#   volumes:
#     - /opt/blacklist-config/redis.conf:/usr/local/etc/redis/redis.conf
#   command: redis-server /usr/local/etc/redis/redis.conf

# 3ï¸âƒ£ ì¬ì‹œì‘
docker-compose restart blacklist-redis

# 4ï¸âƒ£ ì¸ì¦ í…ŒìŠ¤íŠ¸
docker exec -it blacklist-redis redis-cli
> AUTH your_strong_redis_password_here_32_chars
OK
> PING
PONG

# 5ï¸âƒ£ ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì ‘ê·¼ ì‹œë„ (ì‹¤íŒ¨ í™•ì¸)
docker exec -it blacklist-redis redis-cli
> PING
(error) NOAUTH Authentication required.
{{/code}}

---

== 5ï¸âƒ£ Docker ì»¨í…Œì´ë„ˆ ê²©ë¦¬ ==

=== ğŸ”’ User Namespace (UID/GID ë§¤í•‘) ===

{{code language="bash"}}
# /etc/docker/daemon.json

{
  "userns-remap": "default",
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "live-restore": true
}

# Docker ì¬ì‹œì‘
systemctl restart docker

# í™•ì¸
docker info | grep "User Namespace"
{{/code}}

=== ğŸ›¡ï¸  Seccomp í”„ë¡œí•„ (ì‹œìŠ¤í…œ ì½œ ì œí•œ) ===

{{code language="yaml"}}
# docker-compose.ymlì— ì¶”ê°€

services:
  blacklist-app:
    security_opt:
      - seccomp:/opt/seccomp-profile.json  # ì»¤ìŠ¤í…€ í”„ë¡œí•„
      - no-new-privileges:true              # ê¶Œí•œ ìƒìŠ¹ ê¸ˆì§€
    cap_drop:
      - ALL                                 # ëª¨ë“  capability ì œê±°
    cap_add:
      - NET_BIND_SERVICE                    # í¬íŠ¸ ë°”ì¸ë”©ë§Œ í—ˆìš©
    read_only: true                         # ì½ê¸° ì „ìš© íŒŒì¼ì‹œìŠ¤í…œ
    tmpfs:
      - /tmp
      - /var/run
{{/code}}

=== ğŸ“ ì½ê¸° ì „ìš© íŒŒì¼ì‹œìŠ¤í…œ ===

{{code language="yaml"}}
services:
  blacklist-app:
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=100m
      - /var/run:mode=755,size=10m
    volumes:
      - ./app:/app:ro  # ì†ŒìŠ¤ ì½”ë“œ ì½ê¸° ì „ìš©
{{/code}}

---


//ì‘ì„±: ì •ë³´ë³´ì•ˆíŒ€//

----

== ğŸ’¬ Discussion ==

{{info}}
ì´ ë¬¸ì„œì— ëŒ€í•œ ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì´ ìˆìœ¼ì‹œë©´ ì•„ë˜ì— ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.
{{/info}}

{{comment}}
ëŒ“ê¸€ì„ ì¶”ê°€í•˜ì„¸ìš”...
{{/comment}}
