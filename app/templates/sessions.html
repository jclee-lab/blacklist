<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>활성 세션 관리 - Blacklist Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .session-row {
            transition: all 0.2s;
            cursor: pointer;
        }
        .session-row:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .risk-high {
            border-left: 4px solid #dc3545;
        }
        .risk-medium {
            border-left: 4px solid #ffc107;
        }
        .risk-low {
            border-left: 4px solid #28a745;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .filter-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .timeline-dot.active {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .timeline-dot.inactive {
            background-color: #6c757d;
        }
        .timeline-dot.expired {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .session-detail {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-activity"></i> 활성 세션 관리
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house-door"></i> 홈</a>
                <a class="nav-link" href="/integrations"><i class="bi bi-plug"></i> 연동</a>
                <a class="nav-link" href="/collection-logs"><i class="bi bi-file-text"></i> 수집 로그</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-activity"></i> 활성 세션 히스토리</h2>
                <p class="text-muted">실시간 위협 세션 모니터링 및 이력 관리</p>
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="refreshSessions()">
                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                </button>
                <button class="btn btn-outline-secondary" onclick="exportSessions()">
                    <i class="bi bi-download"></i> 내보내기
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle fs-1 mb-2"></i>
                        <h3 class="mb-0" id="activeCount">0</h3>
                        <small>활성 세션</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="bi bi-clock-history fs-1 mb-2"></i>
                        <h3 class="mb-0" id="lastHourCount">0</h3>
                        <small>최근 1시간</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar-day fs-1 mb-2"></i>
                        <h3 class="mb-0" id="last24hCount">0</h3>
                        <small>최근 24시간</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="bi bi-globe fs-1 mb-2"></i>
                        <h3 class="mb-0" id="uniqueCountries">0</h3>
                        <small>고유 국가</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">시간 범위</label>
                    <select class="form-select" id="timeFilter" onchange="refreshSessions()">
                        <option value="1">최근 1시간</option>
                        <option value="24" selected>최근 24시간</option>
                        <option value="168">최근 7일</option>
                        <option value="720">최근 30일</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">세션 상태</label>
                    <select class="form-select" id="statusFilter" onchange="applyFilters()">
                        <option value="all">전체</option>
                        <option value="active">활성</option>
                        <option value="inactive">비활성</option>
                        <option value="expired">만료</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">위험도</label>
                    <select class="form-select" id="riskFilter" onchange="applyFilters()">
                        <option value="all">전체</option>
                        <option value="high">높음</option>
                        <option value="medium">중간</option>
                        <option value="low">낮음</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">국가</label>
                    <input type="text" class="form-control" id="countryFilter" placeholder="예: CN, RU, KR" onkeyup="applyFilters()">
                </div>
            </div>
        </div>

        <!-- Sessions Table -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> 활성 세션 목록</h5>
            </div>
            <div class="card-body">
                <div id="sessionsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session History Chart (placeholder) -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> 세션 추이</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i>
                    시간대별 활성 세션 추이 그래프가 여기에 표시됩니다.
                </div>
                <div id="chartContainer" style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px;">
                    <span class="text-muted">차트 준비 중...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Detail Modal -->
    <div class="modal fade" id="sessionDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">세션 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="sessionDetailContent">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="blockIP()">
                        <i class="bi bi-x-circle"></i> IP 차단
                    </button>
                    <button type="button" class="btn btn-success" onclick="whitelistIP()">
                        <i class="bi bi-check-circle"></i> 화이트리스트 추가
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allSessions = [];
        let filteredSessions = [];
        let currentSession = null;

        // Load sessions on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshSessions();
            // Auto-refresh every 30 seconds
            setInterval(refreshSessions, 30000);
        });

        // Load sessions from API
        async function refreshSessions() {
            const hours = document.getElementById('timeFilter').value;

            try {
                const response = await fetch(`/api/fortinet/active-sessions?hours=${hours}&limit=500`);
                const data = await response.json();

                if (data.success) {
                    allSessions = data.data;

                    // Update statistics
                    document.getElementById('activeCount').textContent = data.stats.active_count;
                    document.getElementById('lastHourCount').textContent = data.stats.last_hour;
                    document.getElementById('last24hCount').textContent = data.stats.last_24h;
                    document.getElementById('uniqueCountries').textContent = data.stats.unique_countries;

                    // Apply filters and render
                    applyFilters();
                } else {
                    showError('세션 로드 실패: ' + data.error);
                }
            } catch (error) {
                showError('세션 로드 오류: ' + error.message);
            }
        }

        // Apply filters to sessions
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            const countryFilter = document.getElementById('countryFilter').value.toUpperCase();

            filteredSessions = allSessions.filter(session => {
                // Status filter
                if (statusFilter !== 'all' && session.session_status !== statusFilter) {
                    return false;
                }

                // Risk level filter
                if (riskFilter !== 'all') {
                    const risk = getRiskLevel(session.confidence_level);
                    if (risk !== riskFilter) {
                        return false;
                    }
                }

                // Country filter
                if (countryFilter && !session.country.toUpperCase().includes(countryFilter)) {
                    return false;
                }

                return true;
            });

            renderSessions();
        }

        // Render sessions table
        function renderSessions() {
            const container = document.getElementById('sessionsContainer');

            if (filteredSessions.length === 0) {
                container.innerHTML = '<div class="alert alert-info">필터 조건에 맞는 세션이 없습니다.</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr>';
            html += '<th>상태</th>';
            html += '<th>IP 주소</th>';
            html += '<th>국가</th>';
            html += '<th>위험도</th>';
            html += '<th>활성 시간</th>';
            html += '<th>탐지일시</th>';
            html += '<th>사유</th>';
            html += '<th>작업</th>';
            html += '</tr></thead><tbody>';

            filteredSessions.forEach(session => {
                const risk = getRiskLevel(session.confidence_level);
                const riskClass = `risk-${risk}`;

                html += `<tr class="session-row ${riskClass}" onclick="showSessionDetail(${session.id})">`;
                html += `<td><span class="timeline-dot ${session.session_status}"></span> ${getStatusLabel(session.session_status)}</td>`;
                html += `<td><strong>${session.ip_address}</strong></td>`;
                html += `<td><span class="badge bg-secondary">${session.country || 'N/A'}</span></td>`;
                html += `<td><span class="badge ${getRiskBadgeClass(risk)}">${getRiskLabel(risk)}</span></td>`;
                html += `<td>${session.active_hours || 0}시간</td>`;
                html += `<td><small>${formatDate(session.detection_date)}</small></td>`;
                html += `<td>${session.reason || 'N/A'}</td>`;
                html += `<td>
                    <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); showSessionDetail(${session.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            html += `<div class="mt-3 text-muted">총 ${filteredSessions.length}개 세션 (전체 ${allSessions.length}개 중)</div>`;

            container.innerHTML = html;
        }

        // Show session detail modal
        function showSessionDetail(sessionId) {
            const session = allSessions.find(s => s.id === sessionId);
            if (!session) return;

            currentSession = session;
            const risk = getRiskLevel(session.confidence_level);

            let html = '<div class="session-detail">';
            html += `<h6><i class="bi bi-info-circle"></i> 기본 정보</h6>`;
            html += `<div class="row mb-3">`;
            html += `<div class="col-md-6"><strong>IP 주소:</strong> ${session.ip_address}</div>`;
            html += `<div class="col-md-6"><strong>국가:</strong> ${session.country || 'N/A'}</div>`;
            html += `<div class="col-md-6"><strong>세션 상태:</strong> <span class="timeline-dot ${session.session_status}"></span> ${getStatusLabel(session.session_status)}</div>`;
            html += `<div class="col-md-6"><strong>위험도:</strong> <span class="badge ${getRiskBadgeClass(risk)}">${getRiskLabel(risk)} (${session.confidence_level}%)</span></div>`;
            html += `</div>`;

            html += `<h6 class="mt-3"><i class="bi bi-clock"></i> 시간 정보</h6>`;
            html += `<div class="row mb-3">`;
            html += `<div class="col-md-6"><strong>탐지일시:</strong> ${formatDate(session.detection_date)}</div>`;
            html += `<div class="col-md-6"><strong>활성 시간:</strong> ${session.active_hours || 0}시간</div>`;
            html += `<div class="col-md-6"><strong>생성일:</strong> ${formatDate(session.created_at)}</div>`;
            html += `<div class="col-md-6"><strong>수정일:</strong> ${formatDate(session.updated_at)}</div>`;
            html += `</div>`;

            html += `<h6 class="mt-3"><i class="bi bi-exclamation-triangle"></i> 위협 정보</h6>`;
            html += `<div class="row">`;
            html += `<div class="col-12"><strong>사유:</strong> ${session.reason || 'N/A'}</div>`;
            html += `</div>`;
            html += '</div>';

            document.getElementById('sessionDetailContent').innerHTML = html;

            const modal = new bootstrap.Modal(document.getElementById('sessionDetailModal'));
            modal.show();
        }

        // Helper functions
        function getRiskLevel(confidence) {
            if (confidence >= 80) return 'high';
            if (confidence >= 50) return 'medium';
            return 'low';
        }

        function getRiskLabel(risk) {
            const labels = { 'high': '높음', 'medium': '중간', 'low': '낮음' };
            return labels[risk] || risk;
        }

        function getRiskBadgeClass(risk) {
            const classes = { 'high': 'bg-danger', 'medium': 'bg-warning', 'low': 'bg-success' };
            return classes[risk] || 'bg-secondary';
        }

        function getStatusLabel(status) {
            const labels = { 'active': '활성', 'inactive': '비활성', 'expired': '만료' };
            return labels[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR');
        }

        function showError(message) {
            alert(message);
        }

        function exportSessions() {
            // Export filtered sessions as CSV
            let csv = 'IP주소,국가,상태,위험도,신뢰도,활성시간,탐지일시,사유\n';
            filteredSessions.forEach(session => {
                const risk = getRiskLevel(session.confidence_level);
                csv += `${session.ip_address},${session.country || 'N/A'},${getStatusLabel(session.session_status)},${getRiskLabel(risk)},${session.confidence_level},${session.active_hours || 0},${formatDate(session.detection_date)},"${session.reason || 'N/A'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `sessions_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function blockIP() {
            if (!currentSession) return;
            alert(`IP ${currentSession.ip_address}를 차단 목록에 추가합니다. (구현 필요)`);
            // TODO: Implement actual blocking logic
        }

        function whitelistIP() {
            if (!currentSession) return;
            alert(`IP ${currentSession.ip_address}를 화이트리스트에 추가합니다. (구현 필요)`);
            // TODO: Implement actual whitelisting logic
        }
    </script>
</body>
</html>
