name: ğŸš€ Cloudflare Workers Deploy

# Cloudflare Workers CI/CD Pipeline with Git Integration
# Auto-deploy on push to master or manual trigger
on:
  push:
    branches: [master]
    paths:
      - 'worker/**'
      - '.github/workflows/cloudflare-workers-deploy.yml'
  pull_request:
    branches: [master]
    paths:
      - 'worker/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - 'production'
        - 'staging'
        - 'preview'

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  NODE_VERSION: '18'

jobs:
  # Job 1: Test and Validate
  test:
    name: ğŸ§ª Test & Validate
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: worker/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./worker
        run: npm ci

      - name: ğŸ” Lint code
        working-directory: ./worker
        run: |
          npm run lint || echo "No lint script defined"

      - name: ğŸ§ª Run tests
        working-directory: ./worker
        run: |
          npm test || echo "No test script defined"

      - name: âœ… Validate wrangler.toml
        working-directory: ./worker
        run: |
          npx wrangler whoami
          npx wrangler types

  # Job 2: Build and Deploy to Preview (PR only)
  preview:
    name: ğŸ‘ï¸ Deploy Preview
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: worker/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./worker
        run: npm ci

      - name: ğŸš€ Deploy to Cloudflare Workers Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: worker
          command: deploy --env preview
          environment: preview

      - name: ğŸ’¬ Comment Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const workerName = 'blacklist';
            const previewUrl = `https://${workerName}-preview.${process.env.CLOUDFLARE_ACCOUNT_ID}.workers.dev`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ Preview deployed successfully!\n\nğŸ”— Preview URL: ${previewUrl}\n\nâœ… This preview will be updated automatically with new commits.`
            })

  # Job 3: Deploy to Production (master branch only)
  deploy:
    name: ğŸš€ Deploy Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
    environment:
      name: production
      url: https://blacklist.workers.jclee.me
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: worker/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./worker
        run: npm ci

      - name: ğŸ—ï¸ Build Worker
        working-directory: ./worker
        run: |
          echo "Building Worker for production..."
          npm run build || echo "No build script, using source directly"

      - name: ğŸš€ Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: worker
          command: deploy
          environment: production

      - name: ğŸ“Š Publish Deployment Metrics
        working-directory: ./worker
        run: |
          echo "Deployment completed at $(date)"
          npx wrangler tail --format json --once || true

      - name: âœ… Verify Deployment
        run: |
          echo "Verifying worker deployment..."
          WORKER_URL="https://blacklist.workers.jclee.me"

          # Wait for deployment to propagate
          sleep 10

          # Check health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" ${WORKER_URL}/health)
          if [ "$response" = "200" ]; then
            echo "âœ… Worker health check passed"
          else
            echo "âŒ Worker health check failed with status: $response"
            exit 1
          fi

          # Check API stats endpoint
          stats_response=$(curl -s ${WORKER_URL}/api/stats | jq -r '.success')
          if [ "$stats_response" = "true" ]; then
            echo "âœ… Worker API check passed"
          else
            echo "âš ï¸ Worker API check returned unexpected response"
          fi

      - name: ğŸ·ï¸ Create Release Tag
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().slice(0, 10);
            const tagName = `worker-deploy-${date}-${{ github.sha.substring(0, 7) }}`;
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              console.log(`âœ… Created deployment tag: ${tagName}`);
            } catch (error) {
              console.log(`Tag might already exist: ${error.message}`);
            }

  # Job 4: Post-deployment Actions
  post-deploy:
    name: ğŸ“‹ Post-Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Update Deployment Status
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker**: blacklist" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://blacklist.workers.jclee.me" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”” Send Notification
        if: always()
        run: |
          # Add notification logic here (Slack, Discord, etc.)
          echo "Deployment notification would be sent here"

  # Job 5: Rollback (Manual trigger only)
  rollback:
    name: âª Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'rollback'
    steps:
      - name: ğŸ“¥ Checkout previous commit
        uses: actions/checkout@v4
        with:
          ref: HEAD~1

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        working-directory: ./worker
        run: npm ci

      - name: âª Rollback to Previous Version
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: worker
          command: rollback