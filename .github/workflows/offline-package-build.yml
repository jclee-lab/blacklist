name: Build Offline Package

on:
  push:
    branches:
      - 'release/**'  # Only trigger on release branches
    tags:
      - 'v*'  # Or on version tags
  workflow_dispatch:  # Manual execution supported

env:
  PACKAGE_DIR: offline-packages

jobs:
  build-offline-package:
    name: Create Offline Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true  # Git LFS ì§€ì›

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: ${VERSION}"

      - name: Check Docker context
        run: |
          echo "Current Docker context:"
          docker context show
          echo ""
          echo "Ensuring local context for build..."
          docker context use default || true

      - name: Build Docker images
        run: |
          echo "ðŸ”¨ Building Docker images from Dockerfiles..."

          # Build all services
          docker compose build --no-cache

          echo "âœ… Docker images built successfully"

      - name: Create offline package
        run: |
          echo "ðŸ“¦ Creating offline package..."

          # Run package creation script
          bash scripts/create-dual-package.sh --use-running || \
            bash scripts/create-dual-package.sh

          echo "âœ… Offline package created"

      - name: Verify package
        run: |
          echo "ðŸ” Verifying package contents..."

          cd ${PACKAGE_DIR}

          # Check tarball
          if [ -f "blacklist.tar.gz" ]; then
            SIZE=$(du -h blacklist.tar.gz | cut -f1)
            echo "âœ… blacklist.tar.gz: ${SIZE}"
          else
            echo "âŒ blacklist.tar.gz not found!"
            exit 1
          fi

          # Check install script
          if [ -f "install.sh" ]; then
            SIZE=$(du -h install.sh | cut -f1)
            echo "âœ… install.sh: ${SIZE}"
          else
            echo "âŒ install.sh not found!"
            exit 1
          fi

          # Verify checksum
          if [ -f "blacklist.tar.gz.sha256" ]; then
            sha256sum -c blacklist.tar.gz.sha256
            echo "âœ… Checksum verified"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: blacklist-offline-v${{ steps.version.outputs.version }}
          path: |
            offline-packages/blacklist.tar.gz
            offline-packages/blacklist.tar.gz.sha256
            offline-packages/install.sh
          retention-days: 90

      - name: Create Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            offline-packages/blacklist.tar.gz
            offline-packages/blacklist.tar.gz.sha256
            offline-packages/install.sh
          body: |
            ## ðŸš€ Blacklist Offline Package v${{ steps.version.outputs.version }}

            ### ðŸ“¦ Package Contents
            - **blacklist.tar.gz** - Docker images (5 services)
            - **install.sh** - Automated installer
            - **blacklist.tar.gz.sha256** - Checksum verification

            ### ðŸ”§ Installation
            ```bash
            # Standard install
            bash install.sh

            # Air-gap mode (skip network checks)
            bash install.sh --skip-network-check
            ```

            ### ðŸ“‹ Version Info
            - Version: ${{ steps.version.outputs.version }}
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
          draft: false
          prerelease: false
          generate_release_notes: true  # ìžë™ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-Release on Main Branch (Latest)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build (Nightly)
          files: |
            offline-packages/blacklist.tar.gz
            offline-packages/blacklist.tar.gz.sha256
            offline-packages/install.sh
          body: |
            ## ðŸŒ™ Latest Nightly Build

            **Auto-generated from main branch**

            ### âš ï¸ Warning
            This is an unstable development build. Use tagged releases for production.

            ### ðŸ“¦ Package Contents
            - **blacklist.tar.gz** - Docker images (5 services)
            - **install.sh** - Automated installer
            - **blacklist.tar.gz.sha256** - Checksum verification

            ### ðŸ“‹ Build Info
            - Branch: main
            - Commit: ${{ github.sha }}
            - Date: ${{ github.event.head_commit.timestamp }}

            ### ðŸ”§ Installation
            ```bash
            bash install.sh --skip-network-check
            ```
          draft: false
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ“¦ Offline Package Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package Size:** $(du -h offline-packages/blacklist.tar.gz | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "**Install Script:** $(du -h offline-packages/install.sh | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts available in Actions tab" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "- Release created: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          fi
