# Airgap Bundle Build Workflow
# =============================
# Manually triggered workflow to create complete airgap deployment bundle
# Exports all 5 Docker images from LXC 220

name: Build Airgap Bundle

on:
  workflow_dispatch:
    inputs:
      include_db_dump:
        description: 'Include database dump in bundle'
        required: false
        default: 'false'
        type: boolean
      version_tag:
        description: 'Version tag for the bundle (e.g., v1.0.0)'
        required: false
        default: ''
        type: string

env:
  LXC_HOST: '192.168.50.220'
  PVE_HOST: '192.168.50.100'

jobs:
  build-airgap:
    name: Build Complete Airgap Bundle
    runs-on: [self-hosted, homelab]
    # Note: Requires self-hosted runner with SSH access to PVE_HOST
    # or pre-built images in registry
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "version=${{ github.event.inputs.version_tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +%Y%m%d)-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: blacklist-frontend:latest
          outputs: type=docker,dest=/tmp/blacklist-frontend.tar

      - name: Prepare images directory
        run: |
          mkdir -p deploy/airgap/images
          
          # Compress frontend image
          gzip -c /tmp/blacklist-frontend.tar > deploy/airgap/images/blacklist-frontend.tar.gz
          
          echo "Frontend image: $(ls -lh deploy/airgap/images/blacklist-frontend.tar.gz)"

      - name: Note about other images
        run: |
          echo "========================================="
          echo "IMPORTANT: Full airgap bundle requires:"
          echo "  - blacklist-app.tar.gz"
          echo "  - blacklist-collector.tar.gz"
          echo "  - blacklist-postgres.tar.gz"
          echo "  - blacklist-redis.tar.gz"
          echo ""
          echo "These must be exported from LXC 220 using:"
          echo "  ./deploy/airgap/build-airgap.sh --from-lxc"
          echo ""
          echo "Or pulled from a container registry"
          echo "========================================="

      - name: Generate checksums
        run: |
          cd deploy/airgap/images
          sha256sum *.tar.gz > checksums.sha256
          cat checksums.sha256

      - name: Create partial bundle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE_NAME="blacklist-frontend-${VERSION}.tar.gz"
          
          tar -czvf ${BUNDLE_NAME} \
            -C deploy/airgap \
            docker-compose.yml \
            install.sh \
            images/
          
          echo "Bundle created: $(ls -lh ${BUNDLE_NAME})"
          sha256sum ${BUNDLE_NAME} | tee ${BUNDLE_NAME}.sha256

      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: airgap-bundle-${{ steps.version.outputs.version }}
          path: |
            blacklist-frontend-*.tar.gz
            blacklist-frontend-*.sha256
          retention-days: 90

      - name: Create Release (if tagged)
        if: github.event.inputs.version_tag != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version_tag }}
          name: Blacklist ${{ github.event.inputs.version_tag }}
          body: |
            ## Airgap Deployment Bundle
            
            This release contains the frontend Docker image for airgap deployment.
            
            ### Installation
            ```bash
            tar -xzf blacklist-frontend-${{ github.event.inputs.version_tag }}.tar.gz
            ./install.sh
            ```
            
            ### Note
            Complete airgap bundle (all 5 images) must be built locally using:
            ```bash
            ./deploy/airgap/build-airgap.sh --from-lxc
            ```
          files: |
            blacklist-frontend-*.tar.gz
            blacklist-frontend-*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
