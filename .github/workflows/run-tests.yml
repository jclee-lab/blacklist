# Reusable workflow: Run tests
# Called by: ci.yml

name: Run Tests

on:
  workflow_call:
    inputs:
      test_type:
        description: 'Test type: backend-unit, backend-integration, frontend-unit, frontend-e2e'
        required: true
        type: string
      artifact_name:
        description: 'Name for test artifacts'
        required: false
        type: string
        default: 'test-results'

jobs:
  test:
    name: ${{ inputs.test_type }}
    runs-on: self-hosted
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: blacklist
          POSTGRES_PASSWORD: blacklist
          POSTGRES_DB: blacklist_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Backend Tests
      - name: Set up Python
        if: startsWith(inputs.test_type, 'backend')
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        if: startsWith(inputs.test_type, 'backend')
        run: |
          pip install -r app/requirements.txt
          pip install -r requirements-dev.txt

      - name: Run backend unit tests
        if: inputs.test_type == 'backend-unit'
        env:
          DATABASE_URL: postgresql://blacklist:blacklist@localhost:5432/blacklist_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          python -m pytest tests/unit -v --cov=app --cov-report=xml --junitxml=junit-backend-unit.xml

      - name: Run backend integration tests
        if: inputs.test_type == 'backend-integration'
        env:
          DATABASE_URL: postgresql://blacklist:blacklist@localhost:5432/blacklist_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          python -m pytest tests/integration -v --junitxml=junit-backend-integration.xml

      # Frontend Tests
      - name: Set up Node.js
        if: startsWith(inputs.test_type, 'frontend')
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        if: startsWith(inputs.test_type, 'frontend')
        working-directory: frontend
        run: npm ci

      - name: Run frontend unit tests
        if: inputs.test_type == 'frontend-unit'
        working-directory: frontend
        run: npm run test -- --reporter=junit --outputFile=../junit-frontend-unit.xml

      - name: Install Playwright browsers
        if: inputs.test_type == 'frontend-e2e'
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        if: inputs.test_type == 'frontend-e2e'
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:2542
        run: npm run test:e2e

      # Upload artifacts
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ inputs.test_type }}
          path: |
            junit-*.xml
            coverage.xml
            frontend/playwright-report/
          retention-days: 7
