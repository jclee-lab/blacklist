# GitLab CI/CD: Build-Only Pipeline
# Triggers on main/master branch push and manual runs
# Features: Security scan, parallel Docker image builds, Registry push

stages:
  - validate
  - security
  - build

variables:
  # GitLab-provided variables (auto-configured)
  # CI_REGISTRY: registry.jclee.me
  # CI_REGISTRY_USER: gitlab-ci-token
  # CI_REGISTRY_PASSWORD: $CI_JOB_TOKEN
  # CI_REGISTRY_IMAGE: registry.jclee.me/jclee/blacklist

  # Docker build optimization
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_BUILDKIT: 1

  # Component image names
  IMAGE_POSTGRES: "${CI_REGISTRY_IMAGE}/blacklist-postgres"
  IMAGE_REDIS: "${CI_REGISTRY_IMAGE}/blacklist-redis"
  IMAGE_COLLECTOR: "${CI_REGISTRY_IMAGE}/blacklist-collector"
  IMAGE_APP: "${CI_REGISTRY_IMAGE}/blacklist-app"
  IMAGE_FRONTEND: "${CI_REGISTRY_IMAGE}/blacklist-frontend"

# ============================================================================
# VALIDATE STAGE - Quick environment checks
# ============================================================================

validate:environment:
  stage: validate
  image: alpine:latest
  script:
    - echo "[OK] GitLab CI/CD environment validation"
    - echo "CI_COMMIT_BRANCH=$CI_COMMIT_BRANCH"
    - echo "CI_REGISTRY=$CI_REGISTRY"
    - echo "CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE"
    - echo "CI_COMMIT_SHA=$CI_COMMIT_SHA"
    - echo "[OK] Validation passed"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual

# ============================================================================
# SECURITY STAGE - Dependency scanning
# ============================================================================

security:python-scan:
  stage: security
  image: python:3.11-slim
  before_script:
    - pip install safety
  script:
    - echo "[SECURITY] Scanning Python dependencies for vulnerabilities..."

    # Scan app dependencies
    - |
      if [ -f app/requirements.txt ]; then
        echo "[SCAN] Checking app/requirements.txt..."
        safety check --file=app/requirements.txt --json > app-safety-report.json || true
        safety check --file=app/requirements.txt || echo "[WARN] Vulnerabilities found in app dependencies"
      fi

    # Scan collector dependencies
    - |
      if [ -f collector/requirements.txt ]; then
        echo "[SCAN] Checking collector/requirements.txt..."
        safety check --file=collector/requirements.txt --json > collector-safety-report.json || true
        safety check --file=collector/requirements.txt || echo "[WARN] Vulnerabilities found in collector dependencies"
      fi

    - echo "[OK] Python security scan completed"

  artifacts:
    paths:
      - "*-safety-report.json"
    expire_in: 30 days
    when: always

  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual

  allow_failure: true

security:javascript-scan:
  stage: security
  image: node:20-slim
  script:
    - echo "[SECURITY] Scanning JavaScript dependencies for vulnerabilities..."

    # Scan frontend dependencies
    - |
      if [ -f frontend/package.json ]; then
        cd frontend
        echo "[SCAN] Checking frontend dependencies..."
        npm audit --json > ../frontend-audit-report.json || true
        npm audit --audit-level=moderate || echo "[WARN] Vulnerabilities found in frontend dependencies"
        cd ..
      fi

    - echo "[OK] JavaScript security scan completed"

  artifacts:
    paths:
      - "*-audit-report.json"
    expire_in: 30 days
    when: always

  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual

  allow_failure: true

security:run-tests:
  stage: security
  image: python:3.11-slim
  before_script:
    - cd app
    - pip install -r requirements.txt
  script:
    - echo "[TEST] Running test suite..."
    - pytest --cov=core --cov-report=term-missing --cov-report=xml || echo "[WARN] Some tests failed"
    - echo "[OK] Tests completed"

  artifacts:
    paths:
      - app/coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: app/coverage.xml
    expire_in: 30 days
    when: always

  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual

  allow_failure: true

# ============================================================================
# BUILD STAGE - Parallel Docker image builds
# ============================================================================

.build-template: &build-template
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    # Docker-in-Docker configuration
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - echo "[AUTH] Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  after_script:
    - docker logout $CI_REGISTRY || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      changes:
        - app/**/*
        - collector/**/*
        - postgres/**/*
        - redis/**/*
        - frontend/**/*
        - Dockerfile*
        - requirements.txt
        - docker-compose.yml
        - .gitlab-ci.yml
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: manual

build:postgres:
  <<: *build-template
  script:
    - echo "[BUILD] Building PostgreSQL image..."
    - echo "[DEBUG] Docker version"
    - docker version
    - echo "[DEBUG] Docker info"
    - docker info

    - export VERSION_TAG="latest"
    - export COMMIT_SHORT=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

    - |
      docker build \
        --cache-from ${IMAGE_POSTGRES}:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg BUILD_DATE=${BUILD_DATE} \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --tag ${IMAGE_POSTGRES}:${VERSION_TAG} \
        --tag ${IMAGE_POSTGRES}:${COMMIT_SHORT} \
        --file ./postgres/Dockerfile \
        ./postgres

    - echo "[PUSH] Pushing PostgreSQL image to registry..."
    - docker push ${IMAGE_POSTGRES}:${VERSION_TAG}
    - docker push ${IMAGE_POSTGRES}:${COMMIT_SHORT}
    - echo "[OK] PostgreSQL build completed"

build:redis:
  <<: *build-template
  script:
    - echo "[BUILD] Building Redis image..."
    - export VERSION_TAG="latest"
    - export COMMIT_SHORT=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

    - |
      docker build \
        --cache-from ${IMAGE_REDIS}:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg BUILD_DATE=${BUILD_DATE} \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --tag ${IMAGE_REDIS}:${VERSION_TAG} \
        --tag ${IMAGE_REDIS}:${COMMIT_SHORT} \
        --file ./redis/Dockerfile \
        ./redis

    - echo "[PUSH] Pushing Redis image to registry..."
    - docker push ${IMAGE_REDIS}:${VERSION_TAG}
    - docker push ${IMAGE_REDIS}:${COMMIT_SHORT}
    - echo "[OK] Redis build completed"

build:collector:
  <<: *build-template
  script:
    - echo "[BUILD] Building Collector image..."
    - export VERSION_TAG="latest"
    - export COMMIT_SHORT=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

    - |
      docker build \
        --cache-from ${IMAGE_COLLECTOR}:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg BUILD_DATE=${BUILD_DATE} \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --tag ${IMAGE_COLLECTOR}:${VERSION_TAG} \
        --tag ${IMAGE_COLLECTOR}:${COMMIT_SHORT} \
        --file ./collector/Dockerfile \
        ./collector

    - echo "[PUSH] Pushing Collector image to registry..."
    - docker push ${IMAGE_COLLECTOR}:${VERSION_TAG}
    - docker push ${IMAGE_COLLECTOR}:${COMMIT_SHORT}
    - echo "[OK] Collector build completed"

build:app:
  <<: *build-template
  script:
    - echo "[BUILD] Building Flask App image..."
    - export VERSION_TAG="latest"
    - export COMMIT_SHORT=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

    - |
      docker build \
        --cache-from ${IMAGE_APP}:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg BUILD_DATE=${BUILD_DATE} \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --tag ${IMAGE_APP}:${VERSION_TAG} \
        --tag ${IMAGE_APP}:${COMMIT_SHORT} \
        --file ./app/Dockerfile \
        ./app

    - echo "[PUSH] Pushing Flask App image to registry..."
    - docker push ${IMAGE_APP}:${VERSION_TAG}
    - docker push ${IMAGE_APP}:${COMMIT_SHORT}
    - echo "[OK] Flask App build completed"

build:frontend:
  <<: *build-template
  script:
    - echo "[BUILD] Building Frontend image..."
    - export VERSION_TAG="latest"
    - export COMMIT_SHORT=$(echo $CI_COMMIT_SHA | cut -c1-8)
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

    - |
      docker build \
        --cache-from ${IMAGE_FRONTEND}:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg BUILD_DATE=${BUILD_DATE} \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --tag ${IMAGE_FRONTEND}:${VERSION_TAG} \
        --tag ${IMAGE_FRONTEND}:${COMMIT_SHORT} \
        --file ./frontend/Dockerfile \
        ./frontend

    - echo "[PUSH] Pushing Frontend image to registry..."
    - docker push ${IMAGE_FRONTEND}:${VERSION_TAG}
    - docker push ${IMAGE_FRONTEND}:${COMMIT_SHORT}
    - echo "[OK] Frontend build completed"

# ============================================================================
